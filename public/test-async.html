<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sistema Asincrono</title>
    <style>
        body { font-family: Arial; max-width: 600px; margin: 50px auto; padding: 20px; }
        .section { margin: 20px 0; padding: 20px; background: #f5f5f5; border-radius: 8px; }
        button { background: #4facfe; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        button:disabled { opacity: 0.5; }
        .progress { width: 100%; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #4facfe, #00f2fe); width: 0%; transition: width 0.3s; }
        .log { background: #2d2d2d; color: #0f0; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .status { font-size: 18px; font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üß™ Test Sistema Code Asincrono</h1>
    
    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
        <h3 style="margin-top: 0;">‚ö†Ô∏è MODALIT√Ä TEST</h3>
        <p style="margin: 5px 0;"><strong>Questa pagina NON salva NULLA nel database!</strong></p>
        <p style="margin: 5px 0; font-size: 14px;">
            ‚úÖ Esegue analisi AI completa<br>
            ‚úÖ Cerca birrificio/birra esistenti<br>
            ‚úÖ Effettua web search/scraping (opzionale)<br>
            ‚ùå ZERO scritture database<br>
        </p>
        <p style="margin: 5px 0; font-size: 12px; color: #856404;">
            Endpoint: <code>/review/test-async-worker</code><br>
            Modalit√†: <span id="modeIndicator">Simulazione (veloce)</span>
        </p>
    </div>
    
    <div class="section">
        <h3>üì§ Upload Test</h3>
        <div style="margin-bottom: 15px;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="useRealServices" style="width: 18px; height: 18px;">
                <span style="font-size: 14px; color: #333;">
                    üîç Usa servizi reali (web search/scraping)
                </span>
            </label>
            <small style="display: block; margin-top: 5px; color: #666; font-size: 12px;">
                Se selezionato, esegue ricerche web reali e scraping invece di simulare i dati.
                Pi√π lento ma pi√π accurato per testare l'integrazione completa.
            </small>
        </div>
        <input type="file" id="file" accept="image/*">
        <button onclick="upload()" id="btn">Testa Upload</button>
    </div>

    <div class="section" id="status" style="display:none">
        <div class="status" id="msg">In attesa...</div>
        <div class="progress"><div class="progress-bar" id="bar"></div></div>
        <small id="details"></small>
    </div>

    <!-- üéØ MOMENTO CHIAVE: L'UTENTE COMPILA MENTRE IL JOB LAVORA -->
    <div class="section" id="reviewForm" style="display:none; background: #fff3cd; border: 2px solid #ffc107;">
        <h3>üìù Form Recensione (Mentre AI lavora in background)</h3>
        <div style="background: #fff; padding: 15px; border-radius: 5px; margin: 10px 0;">
            <p><strong>üç∫ Birra rilevata:</strong> <span id="beerName">Caricamento...</span></p>
            <p><strong>üè≠ Birrificio:</strong> <span id="breweryName">Caricamento...</span></p>
            
            <div style="margin: 15px 0; padding: 10px; background: #e3f2fd; border-left: 4px solid #2196f3;">
                <small>‚ÑπÔ∏è <strong>Puoi iniziare a compilare SUBITO!</strong> L'AI sta ancora analizzando l'immagine in background...</small>
            </div>
            
            <label><strong>‚≠ê Valutazione:</strong></label>
            <select id="rating" style="width: 100%; padding: 8px; margin: 5px 0;">
                <option>1 - Pessima</option>
                <option>2 - Scarsa</option>
                <option>3 - Media</option>
                <option selected>4 - Buona</option>
                <option>5 - Eccellente</option>
            </select>
            
            <label><strong>üí≠ Note:</strong></label>
            <textarea id="notes" rows="3" style="width: 100%; padding: 8px; margin: 5px 0;" placeholder="La tua recensione...">Ottima birra artigianale!</textarea>
            
            <div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                <small>üîÑ <strong>Background Progress:</strong> <span id="bgProgress">0%</span></small>
                <div class="progress" style="height: 8px; margin: 5px 0;">
                    <div class="progress-bar" id="bgBar"></div>
                </div>
            </div>
            
            <button onclick="submitReview()" style="width: 100%; margin-top: 10px; background: #28a745;">
                üíæ Salva Recensione
            </button>
        </div>
    </div>

    <div class="section">
        <h3>üìã Log</h3>
        <div class="log" id="log"></div>
    </div>

    <script>
        function log(msg, color = '#0f0') {
            const l = document.getElementById('log');
            l.innerHTML += `<div style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            l.scrollTop = l.scrollHeight;
        }

        async function upload() {
            const file = document.getElementById('file').files[0];
            if (!file) return alert('Seleziona un file!');
            
            const useRealServices = document.getElementById('useRealServices').checked;
            
            document.getElementById('btn').disabled = true;
            document.getElementById('status').style.display = 'block';
            
            try {
                const endpoint = useRealServices 
                    ? '/review/test-async-worker?useRealServices=true'
                    : '/review/test-async-worker';
                
                log(`üß™ Invio a ${endpoint} (NESSUN SALVATAGGIO DB)...`);
                log(`üîç Modalit√†: ${useRealServices ? 'SERVIZI REALI' : 'SIMULAZIONE'}`, useRealServices ? '#f0f' : '#0ff');
                
                const fd = new FormData();
                fd.append('image', file);
                
                log(`üì¶ File: ${file.name} (${file.size} bytes)`);
                
                // üß™ CHIAMATA CON MODALIT√Ä SELEZIONATA
                const res = await fetch(endpoint, { method: 'POST', body: fd });
                
                log(`üì° Response status: ${res.status} ${res.statusText}`);
                
                const contentType = res.headers.get('content-type');
                log(`üìã Content-Type: ${contentType}`);
                
                const text = await res.text();
                log(`üìÑ Response text (first 200 chars): ${text.substring(0, 200)}`);
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch (parseErr) {
                    log(`‚ùå JSON Parse Error: ${parseErr.message}`, '#f00');
                    log(`üìÑ Full response: ${text}`, '#fa0');
                    throw new Error('Server returned non-JSON response');
                }
                
                if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);
                
                // üß™ RISPOSTA IMMEDIATA: mostra i dati AI iniziali
                log(`‚úÖ Analisi AI completata (TEST MODE - NESSUN SALVATAGGIO DB)`, '#0f0');
                log(`üìä Bottiglie rilevate: ${data.data.initialBottles ? data.data.initialBottles.length : 0}`, '#0ff');
                
                // üéØ MOSTRA I DATI INIZIALI (poi polling per risultati completi)
                if (data.data.initialBottles && data.data.initialBottles.length > 0) {
                    displayInitialResults(data);
                    // Avvia polling per risultati completi
                    startPolling(data.data.reviewId, data.data.useRealServices);
                } else {
                    log('‚ö†Ô∏è Nessuna bottiglia rilevata nei dati di risposta', '#fa0');
                    log('Struttura risposta:', JSON.stringify(data, null, 2));
                }
                
            } catch(e) {
                log(`‚ùå ERRORE: ${e.message}`, '#f00');
                document.getElementById('btn').disabled = false;
            }
        }

        function displayInitialResults(data) {
            log('\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#ff0');
            log('üß™ RISULTATI INIZIALI AI (NESSUN DATO SALVATO)', '#ff0');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#ff0');
            
            // Mostra modalit√† utilizzata
            const useRealServices = data.data.useRealServices || false;
            log(`üîç Modalit√†: ${useRealServices ? 'SERVIZI REALI (web search attivo)' : 'SIMULAZIONE (veloce)'}`, useRealServices ? '#f0f' : '#0ff');
            
            // Mostra dati iniziali AI
            log(`\nüìä DATI AI IMMEDIATI:`, '#0ff');
            log(`  ‚Ä¢ Bottiglie rilevate: ${data.data.initialBottles.length}`, '#fff');
            
            // Processa ogni bottiglia iniziale
            data.data.initialBottles.forEach((bottle, idx) => {
                log(`\n\nüç∫ ============ BOTTIGLIA ${idx + 1} (AI) ============`, '#ff0');
                log(`  ‚Ä¢ beerName: ${bottle.beerName || 'N/A'}`, '#fff');
                log(`  ‚Ä¢ breweryName: ${bottle.breweryName || 'N/A'}`, '#fff');
                log(`  ‚Ä¢ alcoholContent: ${bottle.alcoholContent || 'N/A'}`, '#fff');
                log(`  ‚Ä¢ dataSource: ${bottle.dataSource}`, '#0ff');
            });
            
            log('\n‚è≥ Avvio polling per risultati completi...', '#ff0');
        }
        
        function displayTestResults(data) {
            log('\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#0f0');
            log('üß™ RISULTATI FINALI TEST (NESSUN DATO SALVATO)', '#0f0');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#0f0');
            
            // Mostra modalit√† utilizzata
            const useRealServices = data.useRealServices || false;
            log(`üîç Modalit√† utilizzata: ${useRealServices ? 'SERVIZI REALI' : 'SIMULAZIONE'}`, useRealServices ? '#f0f' : '#0ff');
            
            // Mostra summary
            const summary = data.summary;
            if (summary) {
                log(`\nüìä SUMMARY:`, '#0ff');
                log(`  ‚Ä¢ Totale bottiglie: ${summary.totalBottles}`, '#fff');
                log(`  ‚Ä¢ Birrifici trovati in DB: ${summary.breweriesFound}`, '#fff');
                log(`  ‚Ä¢ Birre trovate in DB: ${summary.beersFound}`, '#fff');
                log(`  ‚Ä¢ Web searches effettuate: ${summary.webSearchesPerformed}`, '#fff');
                log(`  ‚Ä¢ Entit√† da creare: ${summary.needsCreation}`, '#fff');
                log(`  ‚Ä¢ Errori: ${summary.errors}`, '#fff');
            }
            
            // Processa ogni bottiglia
            const bottles = data.bottles || [];
            bottles.forEach((bottle, idx) => {
                log(`\n\nüç∫ ============ BOTTIGLIA ${idx + 1} ============`, '#ff0');
                
                // Dati Birra
                const beer = bottle.beer;
                log(`\nüç∫ BEER MODEL DATA:`, '#4facfe');
                log(`  ‚Ä¢ beerName: ${beer.beerName || 'N/A'}`, '#fff');
                log(`  ‚Ä¢ beerType: ${beer.beerType || 'N/A'}`, '#fff');
                log(`  ‚Ä¢ alcoholContent: ${beer.alcoholContent || 'N/A'}`, '#fff');
                log(`  ‚Ä¢ ibu: ${beer.ibu || 'N/A'}`, '#fff');
                log(`  ‚Ä¢ volume: ${beer.volume || 'N/A'}`, '#fff');
                log(`  ‚Ä¢ description: ${(beer.description || 'N/A').substring(0, 100)}`, '#fff');
                log(`  ‚Ä¢ dataSource: ${beer.dataSource}`, beer.needsCreation ? '#fa0' : '#0f0');
                if (beer.needsCreation) {
                    log(`    ‚ö†Ô∏è DA CREARE IN DATABASE`, '#fa0');
                } else {
                    log(`    ‚úÖ GI√Ä ESISTENTE IN DB (ID: ${beer._id})`, '#0f0');
                }
                
                // Dati Birrificio
                const brewery = bottle.brewery;
                log(`\nüè≠ BREWERY MODEL DATA:`, '#56ab2f');
                log(`  ‚Ä¢ breweryName: ${brewery.breweryName || 'N/A'}`, '#fff');
                log(`  ‚Ä¢ breweryLegalAddress: ${brewery.breweryLegalAddress || 'N/A'}`, '#fff');
                log(`  ‚Ä¢ website: ${brewery.website || 'N/A'}`, '#fff');
                log(`  ‚Ä¢ email: ${brewery.email || 'N/A'}`, '#fff');
                log(`  ‚Ä¢ phone: ${brewery.phone || 'N/A'}`, '#fff');
                log(`  ‚Ä¢ foundingYear: ${brewery.foundingYear || 'N/A'}`, '#fff');
                log(`  ‚Ä¢ dataSource: ${brewery.dataSource}`, brewery.needsCreation ? '#fa0' : '#0f0');
                if (brewery.needsCreation) {
                    log(`    ‚ö†Ô∏è DA CREARE IN DATABASE`, '#fa0');
                } else {
                    log(`    ‚úÖ GI√Ä ESISTENTE IN DB (ID: ${brewery._id})`, '#0f0');
                }
                
                // Metadati processing
                const meta = bottle.metadata;
                if (meta) {
                    log(`\nüìã METADATA:`, '#999');
                    log(`  ‚Ä¢ Birrificio trovato: ${meta.breweryFound ? 'S√¨' : 'No'}`, meta.breweryFound ? '#0f0' : '#f00');
                    log(`  ‚Ä¢ Birra trovata: ${meta.beerFound ? 'S√¨' : 'No'}`, meta.beerFound ? '#0f0' : '#f00');
                    log(`  ‚Ä¢ Web search eseguita: ${meta.webSearchPerformed ? 'S√¨' : 'No'}`, '#fff');
                    log(`  ‚Ä¢ Richiede creazione: ${meta.needsDatabaseCreation ? 'S√¨' : 'No'}`, meta.needsDatabaseCreation ? '#fa0' : '#0f0');
                } else {
                    log(`\nüìã METADATA: N/A (metadata mancante)`, '#f00');
                }
                
                // Dati AI grezzi
                const ai = bottle.aiRawData;
                if (ai) {
                    log(`\nü§ñ AI RAW DATA (DEBUG):`, '#999');
                    log(`  ‚Ä¢ Confidence: ${ai.extractionConfidence || 'N/A'}`, '#fff');
                    log(`  ‚Ä¢ Data source: ${ai.dataSource || 'N/A'}`, '#fff');
                    console.log('  ‚Ä¢ labelData completo:', ai.labelData);
                    console.log('  ‚Ä¢ searchQueries:', ai.searchQueries);
                } else {
                    log(`\nü§ñ AI RAW DATA: N/A (aiRawData mancante)`, '#f00');
                }
            });
            
            log(`\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, '#0f0');
        }
        
        async function startPolling(reviewId, useRealServices) {
            log('üîÑ Inizio polling risultati...', '#ff0');
            const pollUrl = `/review/test-status/${reviewId}`;
            let attempts = 0;
            const maxAttempts = 30; // 60 secondi max (2s * 30)
            
            const poll = async () => {
                attempts++;
                
                try {
                    const res = await fetch(pollUrl);
                    const statusData = await res.json();
                    
                    log(`üì° Polling attempt ${attempts}: status=${statusData.data?.status}`, '#999');
                    
                    if (statusData.data?.status === 'completed' && statusData.data?.result) {
                        log('‚úÖ Processing completato! Mostra risultati finali...', '#0f0');
                        displayTestResults(statusData.data.result);
                        return;
                    }
                    
                    if (statusData.data?.status === 'failed') {
                        log('‚ùå Processing fallito: ' + (statusData.data?.error || 'Unknown error'), '#f00');
                        return;
                    }
                    
                    if (attempts < maxAttempts) {
                        setTimeout(poll, 2000);
                    } else {
                        log('‚è±Ô∏è Timeout polling raggiunto', '#fa0');
                    }
                    
                } catch (err) {
                    log(`‚ùå Polling error: ${err.message}`, '#f00');
                    if (attempts < maxAttempts) {
                        setTimeout(poll, 2000);
                    }
                }
            };
            
            // Avvia primo poll dopo 2 secondi
            setTimeout(poll, 2000);
        }

        async function poll(id) {
            let n = 0;
            const max = 120;
            
            const check = async () => {
                try {
                    n++;
                    const res = await fetch(`/review/${id}/status`);
                    const r = await res.json();
                    const d = r.data;
                    
                    log(`üìä Poll ${n}/${max}: ${d.status} | ${d.currentStep || 'N/A'} | ${d.progress || 0}%`);
                    
                    // üéØ AGGIORNA IL PROGRESSO NEL FORM (background)
                    document.getElementById('bgProgress').textContent = `${d.progress || 0}%`;
                    document.getElementById('bgBar').style.width = `${d.progress || 0}%`;
                    
                    let msg = 'Elaborazione...';
                    let prog = d.progress || 0;
                    
                    if (d.status === 'waiting') { msg = '‚è≥ In coda...'; prog = 10; }
                    else if (d.currentStep === 'ai-analysis') { msg = 'ü§ñ Analisi AI...'; prog = 30; }
                    else if (d.currentStep === 'web-search') { msg = 'üåê Ricerca web...'; prog = 50; }
                    else if (d.currentStep === 'web-scraping') { msg = 'üï∑Ô∏è Web scraping...'; prog = 70; }
                    else if (d.currentStep === 'validation') { msg = '‚úÖ Validazione...'; prog = 90; }
                    else if (d.status === 'completed') { msg = '‚úÖ COMPLETATO!'; prog = 100; }
                    else if (d.status === 'failed') { msg = '‚ùå FALLITO!'; prog = 0; }
                    
                    document.getElementById('msg').textContent = msg;
                    document.getElementById('bar').style.width = prog + '%';
                    document.getElementById('details').textContent = `Status: ${d.status} | Attempts: ${d.attempts || 0}`;
                    
                    if (d.status === 'completed') {
                        log('‚úÖ COMPLETATO!', '#0f0');
                        
                        // üîç DEBUG: Verifica struttura dati
                        console.log('üîç DEBUG - Full result object:', d.result);
                        console.log('üîç DEBUG - Has bottles?', d.result?.bottles);
                        console.log('üîç DEBUG - Bottles length:', d.result?.bottles?.length);
                        
                        // üéØ LOGGA TUTTI I DATI AI RECUPERATI (per Model Beer/Brewery)
                        if (d.result && d.result.bottles && d.result.bottles.length > 0) {
                            console.log('\n\n');
                            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                            console.log('üìä DATI AI RECUPERATI (per salvare su Models)');
                            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                            console.log('\n');
                            
                            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#ff0');
                            log('üìä DATI AI RECUPERATI (per salvare su Models):', '#ff0');
                            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#ff0');
                            
                            d.result.bottles.forEach((bottle, idx) => {
                                console.log('\n');
                                console.log(`üç∫ ============ BOTTIGLIA ${idx + 1} ============`);
                                console.log('\n');
                                
                                log(`\nüç∫ BOTTIGLIA ${idx + 1}:`, '#0ff');
                                log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', '#0ff');
                                
                                // DATI BIRRA (Beer Model)
                                console.log('üç∫ ========== BEER MODEL DATA ==========');
                                console.log('beerName:', bottle.beerName);
                                console.log('beerType:', bottle.beerType);
                                console.log('alcoholContent:', bottle.alcoholContent);
                                console.log('ibu:', bottle.ibu);
                                console.log('volume:', bottle.volume);
                                console.log('description:', bottle.description);
                                console.log('ingredients:', bottle.ingredients);
                                console.log('color:', bottle.color);
                                console.log('servingTemperature:', bottle.servingTemperature);
                                console.log('tastingNotes:', bottle.tastingNotes);
                                console.log('dataSource:', bottle.dataSource);
                                console.log('confidence:', bottle.confidence);
                                
                                log(`\nüç∫ BEER MODEL DATA:`, '#4facfe');
                                log(`  ‚Ä¢ beerName: ${bottle.beerName || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ beerType: ${bottle.beerType || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ alcoholContent: ${bottle.alcoholContent || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ ibu: ${bottle.ibu || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ volume: ${bottle.volume || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ description: ${(bottle.description || 'N/A').substring(0, 100)}...`, '#fff');
                                log(`  ‚Ä¢ ingredients: ${JSON.stringify(bottle.ingredients || [])}`, '#fff');
                                log(`  ‚Ä¢ dataSource: ${bottle.dataSource || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ confidence: ${bottle.confidence || 'N/A'}`, '#fff');
                                
                                // DATI BIRRIFICIO (Brewery Model)
                                console.log('\nüè≠ ========== BREWERY MODEL DATA ==========');
                                console.log('breweryName:', bottle.breweryName);
                                console.log('breweryLegalAddress:', bottle.breweryLegalAddress);
                                console.log('website:', bottle.website);
                                console.log('email:', bottle.email);
                                console.log('phone:', bottle.phone);
                                console.log('foundingYear:', bottle.foundingYear);
                                console.log('brewerySize:', bottle.brewerySize);
                                console.log('productionVolume:', bottle.productionVolume);
                                console.log('breweryDescription:', bottle.breweryDescription);
                                console.log('breweryHistory:', bottle.breweryHistory);
                                console.log('mainProducts:', bottle.mainProducts);
                                console.log('awards:', bottle.awards);
                                console.log('brewerySocialMedia:', bottle.brewerySocialMedia);
                                
                                log(`\nüè≠ BREWERY MODEL DATA:`, '#56ab2f');
                                log(`  ‚Ä¢ breweryName: ${bottle.breweryName || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ breweryLegalAddress: ${bottle.breweryLegalAddress || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ website: ${bottle.website || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ email: ${bottle.email || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ phone: ${bottle.phone || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ foundingYear: ${bottle.foundingYear || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ brewerySize: ${bottle.brewerySize || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ productionVolume: ${bottle.productionVolume || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ mainProducts: ${JSON.stringify(bottle.mainProducts || [])}`, '#fff');
                                log(`  ‚Ä¢ awards: ${JSON.stringify(bottle.awards || [])}`, '#fff');
                                
                                // WEB VERIFICATION DATA
                                if (bottle.webVerification) {
                                    console.log('\nüåê ========== WEB VERIFICATION ==========');
                                    console.log('verified:', bottle.webVerification.verified);
                                    console.log('source:', bottle.webVerification.source);
                                    console.log('confidence:', bottle.webVerification.confidence);
                                    console.log('dataMatch:', bottle.webVerification.dataMatch);
                                    
                                    log(`\nüåê WEB VERIFICATION DATA:`, '#f0f');
                                    log(`  ‚Ä¢ verified: ${bottle.webVerification.verified}`, '#fff');
                                    log(`  ‚Ä¢ source: ${bottle.webVerification.source || 'N/A'}`, '#fff');
                                    log(`  ‚Ä¢ confidence: ${bottle.webVerification.confidence || 'N/A'}`, '#fff');
                                    log(`  ‚Ä¢ dataMatch: ${bottle.webVerification.dataMatch || 'N/A'}`, '#fff');
                                }
                                
                                console.log('\n');
                            });
                            
                            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                            console.log('‚úÖ Fine dati AI');
                            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                            console.log('\n\n');
                            
                            log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#ff0');
                            log('‚úÖ CONTROLLA LA CONSOLE BROWSER (F12) per i dettagli completi!', '#ff0');
                            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n', '#ff0');
                        } else {
                            console.error('‚ùå Nessuna bottiglia trovata nei risultati!');
                            console.log('Struttura result:', d.result);
                            log('‚ùå Nessuna bottiglia trovata nei risultati!', '#f00');
                        }
                        
                        // üéØ AUTO-POPOLA I CAMPI CON I DATI DELL'AI
                        if (d.result && d.result.bottles && d.result.bottles[0]) {
                            const bottle = d.result.bottles[0];
                            document.getElementById('beerName').textContent = bottle.beerName || 'N/A';
                            document.getElementById('breweryName').textContent = bottle.breweryName || 'N/A';
                            log('‚úÖ Form auto-popolato con dati AI!', '#0ff');
                        }
                        
                        document.getElementById('btn').disabled = false;
                    } else if (d.status === 'failed') {
                        log(`‚ùå FALLITO: ${d.error}`, '#f00');
                        document.getElementById('btn').disabled = false;
                    } else if (n < max) {
                        setTimeout(check, 1000);
                    } else {
                        log('‚ö†Ô∏è TIMEOUT!', '#fa0');
                        document.getElementById('btn').disabled = false;
                    }
                } catch(e) {
                    log(`‚ùå Poll error: ${e.message}`, '#f00');
                }
            };
            
            check();
        }

        // üß™ NUOVA FUNZIONE: Mostra risultati test immediati (senza polling)
        function displayTestResults(data) {
            // Simula completamento per aggiornare UI
            document.getElementById('msg').textContent = '‚úÖ COMPLETATO!';
            document.getElementById('bar').style.width = '100%';
            document.getElementById('bgProgress').textContent = '100%';
            document.getElementById('bgBar').style.width = '100%';
            document.getElementById('details').textContent = 'Status: completed | Test Mode: true';
            
            log('‚úÖ COMPLETATO!', '#0f0');
            
            // Mostra modalit√† utilizzata
            const useRealServices = data.useRealServices || false;
            log(`üîç Modalit√† utilizzata: ${useRealServices ? 'SERVIZI REALI' : 'SIMULAZIONE'}`, useRealServices ? '#f0f' : '#0ff');
            
            // üîç DEBUG: Verifica struttura dati
            console.log('üîç DEBUG - Full result object:', data);
            console.log('üîç DEBUG - Has data?', data?.data);
            console.log('üîç DEBUG - Has bottles?', data?.data?.bottles);
            console.log('üîç DEBUG - Bottles length:', data?.data?.bottles?.length);
            
            // üéØ LOGGA TUTTI I DATI AI RECUPERATI (per Model Beer/Brewery)
            if (data && data.data && data.data.bottles && data.data.bottles.length > 0) {
                console.log('\n\n');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('üìä DATI AI RECUPERATI (per salvare su Models)');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('\n');
                
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#ff0');
                log('üìä DATI AI RECUPERATI (per salvare su Models):', '#ff0');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#ff0');
                
                data.data.bottles.forEach((bottle, idx) => {
                    console.log('\n');
                    console.log(`üç∫ ============ BOTTIGLIA ${idx + 1} ============`);
                    console.log('\n');
                    
                    log(`\nüç∫ BOTTIGLIA ${idx + 1}:`, '#0ff');
                    log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', '#0ff');
                    
                    // DATI BIRRA (Beer Model) - struttura piatta dal worker
                    console.log('üç∫ ========== BEER MODEL DATA ==========');
                    console.log('beerName:', bottle.beerName);
                    console.log('beerType:', bottle.beerType);
                    console.log('alcoholContent:', bottle.alcoholContent);
                    console.log('ibu:', bottle.ibu);
                    console.log('volume:', bottle.volume);
                    console.log('description:', bottle.description);
                    console.log('ingredients:', bottle.ingredients);
                    console.log('color:', bottle.color);
                    console.log('servingTemperature:', bottle.servingTemperature);
                    console.log('tastingNotes:', bottle.tastingNotes);
                    console.log('dataSource:', bottle.dataSource);
                    console.log('confidence:', bottle.confidence);
                    
                    log(`\nüç∫ BEER MODEL DATA:`, '#4facfe');
                    log(`  ‚Ä¢ beerName: ${bottle.beerName || 'N/A'}`, '#fff');
                    log(`  ‚Ä¢ beerType: ${bottle.beerType || 'N/A'}`, '#fff');
                    log(`  ‚Ä¢ alcoholContent: ${bottle.alcoholContent || 'N/A'}`, '#fff');
                    log(`  ‚Ä¢ ibu: ${bottle.ibu || 'N/A'}`, '#fff');
                    log(`  ‚Ä¢ volume: ${bottle.volume || 'N/A'}`, '#fff');
                    log(`  ‚Ä¢ description: ${(bottle.description || 'N/A').substring(0, 100)}...`, '#fff');
                    log(`  ‚Ä¢ ingredients: ${JSON.stringify(bottle.ingredients || [])}`, '#fff');
                    log(`  ‚Ä¢ dataSource: ${bottle.dataSource || 'N/A'}`, '#fff');
                    log(`  ‚Ä¢ confidence: ${bottle.confidence || 'N/A'}`, '#fff');
                    
                    // DATI BIRRIFICIO (Brewery Model) - struttura piatta dal worker
                    console.log('\nüè≠ ========== BREWERY MODEL DATA ==========');
                    console.log('breweryName:', bottle.breweryName);
                    console.log('breweryLegalAddress:', bottle.breweryLegalAddress);
                    console.log('website:', bottle.website);
                    console.log('email:', bottle.email);
                    console.log('phone:', bottle.phone);
                    console.log('foundingYear:', bottle.foundingYear);
                    console.log('brewerySize:', bottle.brewerySize);
                    console.log('productionVolume:', bottle.productionVolume);
                    console.log('breweryDescription:', bottle.breweryDescription);
                    console.log('breweryHistory:', bottle.breweryHistory);
                    console.log('mainProducts:', bottle.mainProducts);
                    console.log('awards:', bottle.awards);
                    console.log('brewerySocialMedia:', bottle.brewerySocialMedia);
                    
                    log(`\nüè≠ BREWERY MODEL DATA:`, '#56ab2f');
                    log(`  ‚Ä¢ breweryName: ${bottle.breweryName || 'N/A'}`, '#fff');
                    log(`  ‚Ä¢ breweryLegalAddress: ${bottle.breweryLegalAddress || 'N/A'}`, '#fff');
                    log(`  ‚Ä¢ website: ${bottle.website || 'N/A'}`, '#fff');
                    log(`  ‚Ä¢ email: ${bottle.email || 'N/A'}`, '#fff');
                    log(`  ‚Ä¢ phone: ${bottle.phone || 'N/A'}`, '#fff');
                    log(`  ‚Ä¢ foundingYear: ${bottle.foundingYear || 'N/A'}`, '#fff');
                    log(`  ‚Ä¢ brewerySize: ${bottle.brewerySize || 'N/A'}`, '#fff');
                    log(`  ‚Ä¢ productionVolume: ${bottle.productionVolume || 'N/A'}`, '#fff');
                    log(`  ‚Ä¢ mainProducts: ${JSON.stringify(bottle.mainProducts || [])}`, '#fff');
                    log(`  ‚Ä¢ awards: ${JSON.stringify(bottle.awards || [])}`, '#fff');
                    
                    // WEB VERIFICATION DATA
                    if (bottle.webVerification) {
                        console.log('\nüåê ========== WEB VERIFICATION ==========');
                        console.log('verified:', bottle.webVerification.verified);
                        console.log('source:', bottle.webVerification.source);
                        console.log('confidence:', bottle.webVerification.confidence);
                        console.log('dataMatch:', bottle.webVerification.dataMatch);
                        
                        log(`\nüåê WEB VERIFICATION DATA:`, '#f0f');
                        log(`  ‚Ä¢ verified: ${bottle.webVerification.verified}`, '#fff');
                        log(`  ‚Ä¢ source: ${bottle.webVerification.source || 'N/A'}`, '#fff');
                        log(`  ‚Ä¢ confidence: ${bottle.webVerification.confidence || 'N/A'}`, '#fff');
                        log(`  ‚Ä¢ dataMatch: ${bottle.webVerification.dataMatch || 'N/A'}`, '#fff');
                    }
                    
                    // Metadati processing
                    const meta = bottle.metadata;
                    if (meta) {
                        log(`\nüìã METADATA:`, '#999');
                        log(`  ‚Ä¢ Birrificio trovato: ${meta.breweryFound ? 'S√¨' : 'No'}`, meta.breweryFound ? '#0f0' : '#f00');
                        log(`  ‚Ä¢ Birra trovata: ${meta.beerFound ? 'S√¨' : 'No'}`, meta.beerFound ? '#0f0' : '#f00');
                        log(`  ‚Ä¢ Web search eseguita: ${meta.webSearchPerformed ? 'S√¨' : 'No'}`, '#fff');
                        log(`  ‚Ä¢ Richiede creazione: ${meta.needsDatabaseCreation ? 'S√¨' : 'No'}`, meta.needsDatabaseCreation ? '#fa0' : '#0f0');
                    } else {
                        log(`\nüìã METADATA: N/A (metadata mancante)`, '#f00');
                    }
                    
                    // Dati AI grezzi
                    const ai = bottle.aiRawData;
                    if (ai) {
                        log(`\nü§ñ AI RAW DATA (DEBUG):`, '#999');
                        log(`  ‚Ä¢ Confidence: ${ai.extractionConfidence || 'N/A'}`, '#fff');
                        log(`  ‚Ä¢ Data source: ${ai.dataSource || 'N/A'}`, '#fff');
                        console.log('  ‚Ä¢ labelData completo:', ai.labelData);
                        console.log('  ‚Ä¢ searchQueries:', ai.searchQueries);
                    } else {
                        log(`\nü§ñ AI RAW DATA: N/A (aiRawData mancante)`, '#f00');
                    }
                    
                    console.log('\n');
                });
                
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('‚úÖ Fine dati AI');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('\n\n');
                
                log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#ff0');
                log('‚úÖ CONTROLLA LA CONSOLE BROWSER (F12) per i dettagli completi!', '#ff0');
                log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n', '#ff0');
            } else {
                console.error('‚ùå Nessuna bottiglia trovata nei risultati!');
                console.log('Struttura result:', data);
                log('‚ùå Nessuna bottiglia trovata nei risultati!', '#f00');
            }
            
            // üéØ AUTO-POPOLA I CAMPI CON I DATI DELL'AI
            if (data && data.data && data.data.bottles && data.data.bottles[0]) {
                const bottle = data.data.bottles[0];
                document.getElementById('beerName').textContent = bottle.beerName || 'N/A';
                document.getElementById('breweryName').textContent = bottle.breweryName || 'N/A';
                log('‚úÖ Form auto-popolato con dati AI!', '#0ff');
            }
            
            log(`\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, '#0f0');
            log(`‚úÖ ANALISI COMPLETATA - ZERO SCRITTURE DATABASE`, '#0f0');
            log(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, '#0f0');
            
            document.getElementById('btn').disabled = false;
        }

        async function poll(id) {
            let n = 0;
            const max = 120;
            
            const check = async () => {
                try {
                    n++;
                    const res = await fetch(`/review/${id}/status`);
                    const r = await res.json();
                    const d = r.data;
                    
                    log(`üìä Poll ${n}/${max}: ${d.status} | ${d.currentStep || 'N/A'} | ${d.progress || 0}%`);
                    
                    // üéØ AGGIORNA IL PROGRESSO NEL FORM (background)
                    document.getElementById('bgProgress').textContent = `${d.progress || 0}%`;
                    document.getElementById('bgBar').style.width = `${d.progress || 0}%`;
                    
                    let msg = 'Elaborazione...';
                    let prog = d.progress || 0;
                    
                    if (d.status === 'waiting') { msg = '‚è≥ In coda...'; prog = 10; }
                    else if (d.currentStep === 'ai-analysis') { msg = 'ü§ñ Analisi AI...'; prog = 30; }
                    else if (d.currentStep === 'web-search') { msg = 'üåê Ricerca web...'; prog = 50; }
                    else if (d.currentStep === 'web-scraping') { msg = 'üï∑Ô∏è Web scraping...'; prog = 70; }
                    else if (d.currentStep === 'validation') { msg = '‚úÖ Validazione...'; prog = 90; }
                    else if (d.status === 'completed') { msg = '‚úÖ COMPLETATO!'; prog = 100; }
                    else if (d.status === 'failed') { msg = '‚ùå FALLITO!'; prog = 0; }
                    
                    document.getElementById('msg').textContent = msg;
                    document.getElementById('bar').style.width = prog + '%';
                    document.getElementById('details').textContent = `Status: ${d.status} | Attempts: ${d.attempts || 0}`;
                    
                    if (d.status === 'completed') {
                        log('‚úÖ COMPLETATO!', '#0f0');
                        
                        // üîç DEBUG: Verifica struttura dati
                        console.log('üîç DEBUG - Full result object:', d.result);
                        console.log('üîç DEBUG - Has bottles?', d.result?.bottles);
                        console.log('üîç DEBUG - Bottles length:', d.result?.bottles?.length);
                        
                        // üéØ LOGGA TUTTI I DATI AI RECUPERATI (per Model Beer/Brewery)
                        if (d.result && d.result.bottles && d.result.bottles.length > 0) {
                            console.log('\n\n');
                            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                            console.log('üìä DATI AI RECUPERATI (per salvare su Models)');
                            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                            console.log('\n');
                            
                            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#ff0');
                            log('üìä DATI AI RECUPERATI (per salvare su Models):', '#ff0');
                            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#ff0');
                            
                            d.result.bottles.forEach((bottle, idx) => {
                                console.log('\n');
                                console.log(`üç∫ ============ BOTTIGLIA ${idx + 1} ============`);
                                console.log('\n');
                                
                                log(`\nüç∫ BOTTIGLIA ${idx + 1}:`, '#0ff');
                                log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ', '#0ff');
                                
                                // DATI BIRRA (Beer Model)
                                console.log('üç∫ ========== BEER MODEL DATA ==========');
                                console.log('beerName:', bottle.beerName);
                                console.log('beerType:', bottle.beerType);
                                console.log('alcoholContent:', bottle.alcoholContent);
                                console.log('ibu:', bottle.ibu);
                                console.log('volume:', bottle.volume);
                                console.log('description:', bottle.description);
                                console.log('ingredients:', bottle.ingredients);
                                console.log('color:', bottle.color);
                                console.log('servingTemperature:', bottle.servingTemperature);
                                console.log('tastingNotes:', bottle.tastingNotes);
                                console.log('dataSource:', bottle.dataSource);
                                console.log('confidence:', bottle.confidence);
                                
                                log(`\nüç∫ BEER MODEL DATA:`, '#4facfe');
                                log(`  ‚Ä¢ beerName: ${bottle.beerName || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ beerType: ${bottle.beerType || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ alcoholContent: ${bottle.alcoholContent || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ ibu: ${bottle.ibu || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ volume: ${bottle.volume || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ description: ${(bottle.description || 'N/A').substring(0, 100)}...`, '#fff');
                                log(`  ‚Ä¢ ingredients: ${JSON.stringify(bottle.ingredients || [])}`, '#fff');
                                log(`  ‚Ä¢ dataSource: ${bottle.dataSource || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ confidence: ${bottle.confidence || 'N/A'}`, '#fff');
                                
                                // DATI BIRRIFICIO (Brewery Model)
                                console.log('\nüè≠ ========== BREWERY MODEL DATA ==========');
                                console.log('breweryName:', bottle.breweryName);
                                console.log('breweryLegalAddress:', bottle.breweryLegalAddress);
                                console.log('website:', bottle.website);
                                console.log('email:', bottle.email);
                                console.log('phone:', bottle.phone);
                                console.log('foundingYear:', bottle.foundingYear);
                                console.log('brewerySize:', bottle.brewerySize);
                                console.log('productionVolume:', bottle.productionVolume);
                                console.log('breweryDescription:', bottle.breweryDescription);
                                console.log('breweryHistory:', bottle.breweryHistory);
                                console.log('mainProducts:', bottle.mainProducts);
                                console.log('awards:', bottle.awards);
                                console.log('brewerySocialMedia:', bottle.brewerySocialMedia);
                                
                                log(`\nüè≠ BREWERY MODEL DATA:`, '#56ab2f');
                                log(`  ‚Ä¢ breweryName: ${bottle.breweryName || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ breweryLegalAddress: ${bottle.breweryLegalAddress || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ website: ${bottle.website || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ email: ${bottle.email || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ phone: ${bottle.phone || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ foundingYear: ${bottle.foundingYear || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ brewerySize: ${bottle.brewerySize || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ productionVolume: ${bottle.productionVolume || 'N/A'}`, '#fff');
                                log(`  ‚Ä¢ mainProducts: ${JSON.stringify(bottle.mainProducts || [])}`, '#fff');
                                log(`  ‚Ä¢ awards: ${JSON.stringify(bottle.awards || [])}`, '#fff');
                                
                                // WEB VERIFICATION DATA
                                if (bottle.webVerification) {
                                    console.log('\nüåê ========== WEB VERIFICATION ==========');
                                    console.log('verified:', bottle.webVerification.verified);
                                    console.log('source:', bottle.webVerification.source);
                                    console.log('confidence:', bottle.webVerification.confidence);
                                    console.log('dataMatch:', bottle.webVerification.dataMatch);
                                    
                                    log(`\nüåê WEB VERIFICATION DATA:`, '#f0f');
                                    log(`  ‚Ä¢ verified: ${bottle.webVerification.verified}`, '#fff');
                                    log(`  ‚Ä¢ source: ${bottle.webVerification.source || 'N/A'}`, '#fff');
                                    log(`  ‚Ä¢ confidence: ${bottle.webVerification.confidence || 'N/A'}`, '#fff');
                                    log(`  ‚Ä¢ dataMatch: ${bottle.webVerification.dataMatch || 'N/A'}`, '#fff');
                                }
                                
                                console.log('\n');
                            });
                            
                            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                            console.log('‚úÖ Fine dati AI');
                            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                            console.log('\n\n');
                            
                            log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', '#ff0');
                            log('‚úÖ CONTROLLA LA CONSOLE BROWSER (F12) per i dettagli completi!', '#ff0');
                            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n', '#ff0');
                        } else {
                            console.error('‚ùå Nessuna bottiglia trovata nei risultati!');
                            console.log('Struttura result:', d.result);
                            log('‚ùå Nessuna bottiglia trovata nei risultati!', '#f00');
                        }
                        
                        // üéØ AUTO-POPOLA I CAMPI CON I DATI DELL'AI
                        if (d.result && d.result.bottles && d.result.bottles[0]) {
                            const bottle = d.result.bottles[0];
                            document.getElementById('beerName').textContent = bottle.beerName || 'N/A';
                            document.getElementById('breweryName').textContent = bottle.breweryName || 'N/A';
                            log('‚úÖ Form auto-popolato con dati AI!', '#0ff');
                        }
                        
                        document.getElementById('btn').disabled = false;
                    } else if (d.status === 'failed') {
                        log(`‚ùå FALLITO: ${d.error}`, '#f00');
                        document.getElementById('btn').disabled = false;
                    } else if (n < max) {
                        setTimeout(check, 1000);
                    } else {
                        log('‚ö†Ô∏è TIMEOUT!', '#fa0');
                        document.getElementById('btn').disabled = false;
                    }
                } catch(e) {
                    log(`‚ùå Poll error: ${e.message}`, '#f00');
                }
            };
            
            check();
        }

        function submitReview() {
            const rating = document.getElementById('rating').value;
            const notes = document.getElementById('notes').value;
            const beer = document.getElementById('beerName').textContent;
            const brewery = document.getElementById('breweryName').textContent;
            
            log(`üíæ RECENSIONE SALVATA!`, '#0f0');
            log(`   üç∫ Birra: ${beer}`, '#0ff');
            log(`   üè≠ Birrificio: ${brewery}`, '#0ff');
            log(`   ‚≠ê Voto: ${rating}`, '#0ff');
            log(`   üí≠ Note: ${notes}`, '#0ff');
            
            alert('‚úÖ Recensione salvata con successo!\n\n' + 
                  'üç∫ ' + beer + '\n' +
                  'üè≠ ' + brewery + '\n' +
                  '‚≠ê ' + rating + '\n' +
                  'üí≠ ' + notes);
        }
        
        log('‚úÖ Sistema pronto!');
        
        // üéØ AGGIUNGI EVENT LISTENER PER AGGIORNARE INDICATORE MODALIT√Ä
        document.getElementById('useRealServices').addEventListener('change', function() {
            const modeIndicator = document.getElementById('modeIndicator');
            if (this.checked) {
                modeIndicator.textContent = 'Servizi reali (lento)';
                modeIndicator.style.color = '#e91e63';
                modeIndicator.style.fontWeight = 'bold';
            } else {
                modeIndicator.textContent = 'Simulazione (veloce)';
                modeIndicator.style.color = '#4caf50';
                modeIndicator.style.fontWeight = 'normal';
            }
        });
    </script>
</body>
</html>
