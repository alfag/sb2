{% extends "layout.njk" %}

{% block title %}Completa il tuo Profilo - SharingBeer 2.0{% endblock %}

{% block content %}
<!-- Modern Complete Profile Container -->
<div class="complete-profile-container">
    <div class="profile-wrapper">
        <!-- Profile Header -->
        <div class="profile-hero">
            <div class="hero-content">
                <div class="user-avatar">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" fill="currentColor"/>
                    </svg>
                </div>
                <div class="user-info">
                    <h1>Ciao, {{ user.customerDetails.customerName if user.customerDetails and user.customerDetails.customerName else user.username }}!</h1>
                    <div class="role-collection">
                        {% for role in user.role %}
                            <span class="role-chip {{ role }} {% if activeRole == role %}active{% endif %}">
                                {% if role == 'customer' %}
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z" fill="currentColor"/>
                                    </svg>
                                {% elif role == 'brewery' %}
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="currentColor"/>
                                    </svg>
                                {% elif role == 'administrator' %}
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1M12,4.5L18,7.5V11C18,15.19 15.69,19.28 12,20.5C8.31,19.28 6,15.19 6,11V7.5L12,4.5Z" fill="currentColor"/>
                                    </svg>
                                {% endif %}
                                {{ role|capitalize }}
                            </span>
                        {% endfor %}
                    </div>
                    <p>Completa e gestisci tutti i tuoi dati da questa dashboard centralizzata</p>
                </div>
            </div>
        </div>

        <!-- Alert Messages -->
        {% if message.error %}
            <div class="alert alert-error">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM13 17h-2v-2h2v2zm0-4h-2V7h2v6z" fill="currentColor"/>
                </svg>
                {{ message.error }}
            </div>
        {% endif %}
        {% if message.info %}
            <div class="alert alert-info">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="currentColor"/>
                </svg>
                {{ message.info }}
            </div>
        {% endif %}

        <!-- Modern Tabs Container -->
        <div class="modern-tabs-container">
            <!-- Enhanced Tab Navigation -->
            <div class="modern-tabs-nav">
                <button class="modern-tab-button active" data-tab="account">
                    <div class="tab-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.82,11.69,4.82,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z" fill="currentColor"/>
                        </svg>
                    </div>
                    <div class="tab-text">
                        <span class="tab-title">Account</span>
                        <span class="tab-subtitle">Impostazioni base</span>
                    </div>
                </button>
                <button class="modern-tab-button" data-tab="customer">
                    <div class="tab-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" fill="currentColor"/>
                        </svg>
                    </div>
                    <div class="tab-text">
                        <span class="tab-title">Dati Personali</span>
                        <span class="tab-subtitle">Info cliente</span>
                    </div>
                </button>
                {% if user.role.includes('brewery') %}
                <button class="modern-tab-button" data-tab="brewery">
                    <div class="tab-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="currentColor"/>
                        </svg>
                    </div>
                    <div class="tab-text">
                        <span class="tab-title">Birrificio</span>
                        <span class="tab-subtitle">Gestione brewery</span>
                    </div>
                </button>
                {% endif %}
            </div>

            <!-- Tab 1: Account Settings -->
            <div id="account-tab" class="modern-tab-content active">
                <form class="modern-form" method="POST" action="/complete-profile">
                    <input type="hidden" name="section" value="account">
                    
                    <div class="form-section-modern">
                        <div class="section-header">
                            <h2 class="section-title">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.82,11.69,4.82,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z" fill="currentColor"/>
                                </svg>
                                Impostazioni Account
                            </h2>
                            <p class="section-description">Configura le impostazioni di base del tuo account</p>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="username" class="form-label">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z" fill="currentColor"/>
                                    </svg>
                                    Username/Email
                                </label>
                                <input type="text" id="username" name="username" value="{{ user.username }}" class="form-input" required>
                                <small class="form-hint">Il tuo identificativo univoco sulla piattaforma</small>
                            </div>
                            <div class="form-group">
                                <label for="defaultRole" class="form-label">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 1l3.09 6.26L22 8.27l-5 4.87 1.18 6.88L12 16.77l-6.18 3.25L7 13.14 2 8.27l6.91-1.01L12 1z" fill="currentColor"/>
                                    </svg>
                                    Ruolo Predefinito
                                </label>
                                <select id="defaultRole" name="defaultRole" class="form-select">
                                    {% for role in user.role %}
                                        {% if role != 'administrator' %}
                                            <option value="{{ role }}" {% if user.defaultRole == role %}selected{% endif %}>
                                                {{ role | capitalize }}
                                                {% if role == 'customer' %} - Modalità Cliente{% elif role == 'brewery' %} - Modalità Birrificio{% endif %}
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <small class="form-hint">Ruolo attivato automaticamente al login</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-large">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" fill="currentColor"/>
                            </svg>
                            Salva Impostazioni Account
                        </button>
                    </div>
                </form>
                
                <!-- Sezione Preferenze Geolocalizzazione (separata dal form principale) -->
                <div class="form-section-modern" style="margin-top: 2rem;">
                    <div class="section-header">
                        <h2 class="section-title">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="currentColor"/>
                            </svg>
                            Preferenze Geolocalizzazione
                        </h2>
                        <p class="section-description">Gestisci il consenso per la condivisione della posizione durante le recensioni</p>
                    </div>
                    
                    <div class="geolocation-preference-card">
                        <div class="preference-status">
                            {% set locationConsent = user.customerDetails.locationConsent if user.customerDetails and user.customerDetails.locationConsent else {} %}
                            {% set consentEnabled = locationConsent.enabled %}
                            <div class="status-indicator {% if consentEnabled == true %}enabled{% elif consentEnabled == false %}disabled{% else %}ask-always{% endif %}">
                                {% if consentEnabled == true %}
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="currentColor"/>
                                    </svg>
                                    <span>Abilitata</span>
                                {% elif consentEnabled == false %}
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="currentColor"/>
                                    </svg>
                                    <span>Disabilitata</span>
                                {% else %}
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" fill="currentColor"/>
                                    </svg>
                                    <span>Chiedi ogni volta</span>
                                {% endif %}
                            </div>
                            {% if locationConsent.lastUpdated %}
                            <small class="last-updated">Ultimo aggiornamento: {{ locationConsent.lastUpdated | date('DD/MM/YYYY HH:mm') }}</small>
                            {% endif %}
                        </div>
                        
                        <div class="preference-options">
                            <label class="radio-option {% if consentEnabled == true %}selected{% endif %}">
                                <input type="radio" name="locationConsentOption" value="enabled" {% if consentEnabled == true %}checked{% endif %}>
                                <span class="radio-custom"></span>
                                <span class="radio-content">
                                    <strong>Sempre abilitata</strong>
                                    <small>La posizione verrà condivisa automaticamente con ogni recensione</small>
                                </span>
                            </label>
                            
                            <label class="radio-option {% if consentEnabled == false %}selected{% endif %}">
                                <input type="radio" name="locationConsentOption" value="disabled" {% if consentEnabled == false %}checked{% endif %}>
                                <span class="radio-custom"></span>
                                <span class="radio-content">
                                    <strong>Sempre disabilitata</strong>
                                    <small>Non verrà mai richiesta la posizione</small>
                                </span>
                            </label>
                            
                            <label class="radio-option {% if consentEnabled == null or consentEnabled == undefined %}selected{% endif %}">
                                <input type="radio" name="locationConsentOption" value="ask" {% if consentEnabled == null or consentEnabled == undefined %}checked{% endif %}>
                                <span class="radio-custom"></span>
                                <span class="radio-content">
                                    <strong>Chiedi ogni volta</strong>
                                    <small>Ti verrà chiesto se condividere la posizione ad ogni recensione</small>
                                </span>
                            </label>
                        </div>
                        
                        <button type="button" id="saveLocationPreference" class="btn btn-primary btn-save-location">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" fill="currentColor"/>
                            </svg>
                            Salva Preferenza
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Customer Details -->
            <div id="customer-tab" class="modern-tab-content">
                <form class="modern-form" method="POST" action="/complete-profile">
                    <input type="hidden" name="section" value="customer">
                    
                    <!-- Personal Information Section -->
                    <div class="form-section-modern">
                        <div class="section-header">
                            <h2 class="section-title">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" fill="currentColor"/>
                                </svg>
                                Informazioni Personali
                            </h2>
                            <p class="section-description">I tuoi dati anagrafici e di contatto</p>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="customerName" class="form-label">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z" fill="currentColor"/>
                                    </svg>
                                    Nome
                                </label>
                                <input type="text" id="customerName" name="customerName" 
                                       value="{{ user.customerDetails.customerName if user.customerDetails }}" 
                                       class="form-input" placeholder="Il tuo nome">
                            </div>
                            <div class="form-group">
                                <label for="customerSurname" class="form-label">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z" fill="currentColor"/>
                                    </svg>
                                    Cognome
                                </label>
                                <input type="text" id="customerSurname" name="customerSurname" 
                                       value="{{ user.customerDetails.customerSurname if user.customerDetails }}" 
                                       class="form-input" placeholder="Il tuo cognome">
                            </div>
                        </div>
                        
                        <div class="form-grid">
                            {# Task 21: Rimosso campo Codice Fiscale - Non più richiesto per utenti customer #}
                            <div class="form-group">
                                <label for="customerPhoneNumber" class="form-label">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z" fill="currentColor"/>
                                    </svg>
                                    Numero di Telefono
                                </label>
                                <input type="tel" id="customerPhoneNumber" name="customerPhoneNumber" 
                                       value="{{ user.customerDetails.customerPhoneNumber if user.customerDetails }}" 
                                       class="form-input" placeholder="+39 123 456 7890">
                                <small class="form-hint">Formato: +39 seguito dal numero</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Address Section -->
                    <div class="form-section-modern">
                        <div class="section-header">
                            <h2 class="section-title">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="currentColor"/>
                                </svg>
                                Indirizzi
                            </h2>
                            <p class="section-description">I tuoi indirizzi per fatturazione e spedizione</p>
                        </div>
                        
                        <div class="form-grid address-grid">
                            <div class="form-group">
                                <label for="billingAddress" class="form-label">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" fill="currentColor"/>
                                    </svg>
                                    Indirizzo di Fatturazione
                                </label>
                                <textarea id="billingAddress" name="billingAddress" class="form-textarea"
                                          placeholder="Via, numero civico, CAP, città, provincia">{{ user.customerDetails.customerAddresses.billingAddress if user.customerDetails and user.customerDetails.customerAddresses }}</textarea>
                                <small class="form-hint">Indirizzo dove ricevere le fatture</small>
                            </div>
                            <div class="form-group">
                                <label for="shippingAddress" class="form-label">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M3,4A2,2 0 0,0 1,6V17H3A3,3 0 0,0 6,20A3,3 0 0,0 9,17H15A3,3 0 0,0 18,20A3,3 0 0,0 21,17H23V12L20,8H17V4M10,6L14,10L10,14V11H4V9H10M6,15.5A1.5,1.5 0 0,1 7.5,17A1.5,1.5 0 0,1 6,18.5A1.5,1.5 0 0,1 4.5,17A1.5,1.5 0 0,1 6,15.5M18,15.5A1.5,1.5 0 0,1 19.5,17A1.5,1.5 0 0,1 18,18.5A1.5,1.5 0 0,1 16.5,17A1.5,1.5 0 0,1 18,15.5Z" fill="currentColor"/>
                                    </svg>
                                    Indirizzo di Spedizione
                                </label>
                                <textarea id="shippingAddress" name="shippingAddress" class="form-textarea"
                                          placeholder="Via, numero civico, CAP, città, provincia">{{ user.customerDetails.customerAddresses.shippingAddress if user.customerDetails and user.customerDetails.customerAddresses }}</textarea>
                                <small class="form-hint">Indirizzo dove ricevere le spedizioni</small>
                                <div class="address-helper">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="sameAddress" onchange="copySameAddress()">
                                        <span class="checkmark"></span>
                                        Usa lo stesso indirizzo per la spedizione
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-large">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" fill="currentColor"/>
                            </svg>
                            Salva Dati Cliente
                        </button>
                    </div>
                </form>
            </div>

            <!-- Tab 3: Brewery Details -->
            {% if user.role.includes('brewery') %}
            <div id="brewery-tab" class="modern-tab-content">
                <form class="modern-form" method="POST" action="/complete-profile" enctype="multipart/form-data">
                    <input type="hidden" name="section" value="brewery">
                    
                    {% if not user.breweryDetails %}
                    <!-- Brewery Selection Section -->
                    <div class="brewery-selection-section">
                        <div class="selection-header">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="currentColor"/>
                            </svg>
                            <h2>Associa il tuo Birrificio</h2>
                            <p>Seleziona il birrificio che gestisci dalla lista disponibile o contatta l'amministratore per crearne uno nuovo</p>
                        </div>
                        <div class="form-group">
                            <label for="selectedBreweryId" class="form-label">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="currentColor"/>
                                </svg>
                                Birrifici Disponibili
                            </label>
                            <select id="selectedBreweryId" name="selectedBreweryId" class="form-select">
                                <option value="">-- Seleziona il tuo birrificio --</option>
                                {% for brewery in availableBreweries %}
                                    <option value="{{ brewery._id }}">{{ brewery.breweryName }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-hint">Scegli dalla lista dei birrifici registrati nella piattaforma</small>
                        </div>
                        <div class="contact-admin">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z" fill="currentColor"/>
                            </svg>
                            <h3>Il tuo birrificio non è nella lista?</h3>
                            <p>Contatta l'amministratore per registrare il tuo birrificio nella piattaforma</p>
                            <a href="mailto:admin@sharingbeer.com" class="btn btn-secondary">Contatta Amministratore</a>
                        </div>
                    </div>
                    {% else %}
                    <!-- Brewery Management Sections -->
                    <div class="form-section-modern">
                        <div class="section-header">
                            <h2 class="section-title">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="currentColor"/>
                                </svg>
                                Informazioni Generali
                            </h2>
                            <p class="section-description">I dati principali del tuo birrificio</p>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="breweryName" class="form-label required">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="currentColor"/>
                                    </svg>
                                    Nome Birrificio
                                </label>
                                <input type="text" id="breweryName" name="breweryName" 
                                       value="{{ user.breweryDetails.breweryName if user.breweryDetails }}" 
                                       class="form-input" required>
                                <small class="form-hint">Il nome ufficiale del tuo birrificio</small>
                            </div>
                            <div class="form-group">
                                <label for="foundingYear" class="form-label">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="currentColor"/>
                                    </svg>
                                    Anno di Fondazione
                                </label>
                                <input type="number" id="foundingYear" name="foundingYear" 
                                       value="{{ user.breweryDetails.foundingYear if user.breweryDetails }}" 
                                       class="form-input" min="1800" max="2025" placeholder="2020">
                                <small class="form-hint">L'anno in cui è stato fondato il birrificio</small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="breweryDescription" class="form-label">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="currentColor"/>
                                </svg>
                                Descrizione del Birrificio
                            </label>
                            <textarea id="breweryDescription" name="breweryDescription" class="form-textarea"
                                      placeholder="Racconta la storia e la filosofia del tuo birrificio, le tue specialità e ciò che ti rende unico...">{{ user.breweryDetails.breweryDescription if user.breweryDetails }}</textarea>
                            <small class="form-hint">Descrizione che apparirà nella tua pagina pubblica</small>
                        </div>
                    </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-file-alt"></i> Dati Fiscali e Legali</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="breweryFiscalCode">Codice Fiscale/P.IVA</label>
                            <input type="text" id="breweryFiscalCode" name="breweryFiscalCode" 
                                   value="{{ user.breweryDetails.breweryFiscalCode if user.breweryDetails }}">
                        </div>
                        <div class="form-group">
                            <label for="breweryREAcode">Codice REA</label>
                            <input type="text" id="breweryREAcode" name="breweryREAcode" 
                                   value="{{ user.breweryDetails.breweryREAcode if user.breweryDetails }}">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="breweryacciseCode">Codice Accise</label>
                            <input type="text" id="breweryacciseCode" name="breweryacciseCode" 
                                   value="{{ user.breweryDetails.breweryacciseCode if user.breweryDetails }}">
                        </div>
                        <div class="form-group">
                            <label for="breweryLegalAddress">Indirizzo Legale</label>
                            <input type="text" id="breweryLegalAddress" name="breweryLegalAddress" 
                                   value="{{ user.breweryDetails.breweryLegalAddress if user.breweryDetails }}">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-phone"></i> Contatti</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="breweryPhoneNumber">Telefono</label>
                            <input type="tel" id="breweryPhoneNumber" name="breweryPhoneNumber" 
                                   value="{{ user.breweryDetails.breweryPhoneNumber if user.breweryDetails }}">
                        </div>
                        <div class="form-group">
                            <label for="breweryEmail">Email</label>
                            <input type="email" id="breweryEmail" name="breweryEmail" 
                                   value="{{ user.breweryDetails.breweryEmail if user.breweryDetails }}">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="breweryWebsite">Sito Web</label>
                        <input type="url" id="breweryWebsite" name="breweryWebsite" 
                               value="{{ user.breweryDetails.breweryWebsite if user.breweryDetails }}" 
                               placeholder="https://example.com">
                    </div>
                </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-industry"></i> Dettagli Produzione</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="brewerySize">Dimensione Birrificio</label>
                            <select id="brewerySize" name="brewerySize">
                                <option value="">-- Seleziona --</option>
                                <option value="microbirrificio" {% if user.breweryDetails.brewerySize == 'microbirrificio' %}selected{% endif %}>Microbirrificio</option>
                                <option value="birrificio artigianale" {% if user.breweryDetails.brewerySize == 'birrificio artigianale' %}selected{% endif %}>Birrificio Artigianale</option>
                                <option value="industriale" {% if user.breweryDetails.brewerySize == 'industriale' %}selected{% endif %}>Industriale</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="employeeCount">Numero Dipendenti</label>
                            <input type="text" id="employeeCount" name="employeeCount" 
                                   value="{{ user.breweryDetails.employeeCount if user.breweryDetails }}" 
                                   placeholder="es. 1-10, 10-50, 50+">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productionVolume">Volume di Produzione Annuo</label>
                            <input type="text" id="productionVolume" name="productionVolume" 
                                   value="{{ user.breweryDetails.productionVolume if user.breweryDetails }}" 
                                   placeholder="es. 1000 hl/anno">
                        </div>
                        <div class="form-group">
                            <label for="distributionArea">Area di Distribuzione</label>
                            <input type="text" id="distributionArea" name="distributionArea" 
                                   value="{{ user.breweryDetails.distributionArea if user.breweryDetails }}" 
                                   placeholder="es. Locale, Regionale, Nazionale">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="masterBrewer">Mastro Birraio</label>
                            <input type="text" id="masterBrewer" name="masterBrewer" 
                                   value="{{ user.breweryDetails.masterBrewer if user.breweryDetails }}">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="breweryHistory">Storia del Birrificio</label>
                        <textarea id="breweryHistory" name="breweryHistory" 
                                  placeholder="Racconta la storia del tuo birrificio, le tradizioni, le innovazioni...">{{ user.breweryDetails.breweryHistory if user.breweryDetails }}</textarea>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-share-alt"></i> Social Media</h3>
                    
                    <div class="social-media-grid">
                        <div class="form-group">
                            <label for="facebook"><i class="fab fa-facebook"></i> Facebook</label>
                            <input type="url" id="facebook" name="facebook" 
                                   value="{{ user.breweryDetails.brewerySocialMedia.facebook if user.breweryDetails and user.breweryDetails.brewerySocialMedia }}" 
                                   placeholder="https://facebook.com/...">
                        </div>
                        <div class="form-group">
                            <label for="instagram"><i class="fab fa-instagram"></i> Instagram</label>
                            <input type="url" id="instagram" name="instagram" 
                                   value="{{ user.breweryDetails.brewerySocialMedia.instagram if user.breweryDetails and user.breweryDetails.brewerySocialMedia }}" 
                                   placeholder="https://instagram.com/...">
                        </div>
                        <div class="form-group">
                            <label for="twitter"><i class="fab fa-twitter"></i> Twitter</label>
                            <input type="url" id="twitter" name="twitter" 
                                   value="{{ user.breweryDetails.brewerySocialMedia.twitter if user.breweryDetails and user.breweryDetails.brewerySocialMedia }}" 
                                   placeholder="https://twitter.com/...">
                        </div>
                        <div class="form-group">
                            <label for="linkedin"><i class="fab fa-linkedin"></i> LinkedIn</label>
                            <input type="url" id="linkedin" name="linkedin" 
                                   value="{{ user.breweryDetails.brewerySocialMedia.linkedin if user.breweryDetails and user.breweryDetails.brewerySocialMedia }}" 
                                   placeholder="https://linkedin.com/...">
                        </div>
                        <div class="form-group">
                            <label for="youtube"><i class="fab fa-youtube"></i> YouTube</label>
                            <input type="url" id="youtube" name="youtube" 
                                   value="{{ user.breweryDetails.brewerySocialMedia.youtube if user.breweryDetails and user.breweryDetails.brewerySocialMedia }}" 
                                   placeholder="https://youtube.com/...">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-images"></i> Immagini e Logo</h3>
                    
                    <!-- Upload Logo -->
                    <div class="upload-section">
                        <h4>Logo Birrificio</h4>
                        {% if user.breweryDetails.breweryLogo %}
                            <img src="{{ user.breweryDetails.breweryLogo }}" class="brewery-logo-preview" alt="Logo Birrificio">
                        {% endif %}
                        <div class="file-upload">
                            <input type="file" id="breweryLogo" name="breweryLogo" accept="image/*">
                            <label for="breweryLogo" class="file-upload-label">
                                <i class="fas fa-upload"></i> Carica nuovo logo
                            </label>
                        </div>
                    </div>
                    
                    <!-- Upload Immagini -->
                    <div class="upload-section">
                        <h4>Galleria Immagini</h4>
                        <div class="file-upload">
                            <input type="file" id="breweryImages" name="breweryImages" accept="image/*" multiple>
                            <label for="breweryImages" class="file-upload-label">
                                <i class="fas fa-images"></i> Aggiungi immagini (max 10)
                            </label>
                        </div>
                        
                        {% if user.breweryDetails.breweryImages and user.breweryDetails.breweryImages.length > 0 %}
                        <div class="images-gallery">
                            {% for image in user.breweryDetails.breweryImages %}
                            <div class="image-item">
                                <img src="{{ image }}" alt="Immagine Birrificio">
                                <button type="button" class="image-remove" onclick="removeImage('{{ image }}')">×</button>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-large">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" fill="currentColor"/>
                            </svg>
                            {% if not user.breweryDetails %}
                                Associa Birrificio
                            {% else %}
                                Salva Dati Birrificio
                            {% endif %}
                        </button>
                    </div>
                </form>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modern Complete Profile Styles -->
<style>
:root {
    --color-primary: #4f46e5;
    --color-primary-50: #eef2ff;
    --color-secondary: #6b7280;
    --color-success: #10b981;
    --color-warning: #f59e0b;
    --color-error: #ef4444;
    --color-info: #3b82f6;
    --color-white: #ffffff;
    --color-gray-50: #f9fafb;
    --color-gray-100: #f3f4f6;
    --color-gray-200: #e5e7eb;
    --color-gray-300: #d1d5db;
    --color-gray-400: #9ca3af;
    --color-gray-500: #6b7280;
    --color-gray-600: #4b5563;
    --color-gray-700: #374151;
    --color-gray-800: #1f2937;
    --color-gray-900: #111827;
    
    --space-1: 0.25rem;
    --space-2: 0.5rem;
    --space-3: 0.75rem;
    --space-4: 1rem;
    --space-6: 1.5rem;
    --space-8: 2rem;
    --space-12: 3rem;
    
    --text-xs: 0.75rem;
    --text-sm: 0.875rem;
    --text-base: 1rem;
    --text-lg: 1.125rem;
    --text-xl: 1.25rem;
    --text-2xl: 1.5rem;
    --text-3xl: 1.875rem;
    
    --font-normal: 400;
    --font-medium: 500;
    --font-semibold: 600;
    --font-bold: 700;
    
    --radius-md: 0.375rem;
    --radius-lg: 0.5rem;
    --radius-xl: 0.75rem;
    --radius-2xl: 1rem;
    --radius-full: 9999px;
    
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    
    --transition-fast: 150ms ease;
    --transition-base: 300ms ease;
}

.complete-profile-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: var(--space-8);
}

.profile-wrapper {
    background: var(--color-white);
    border-radius: var(--radius-2xl);
    box-shadow: var(--shadow-xl);
    overflow: hidden;
}

.profile-hero {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-info) 100%);
    padding: var(--space-4) var(--space-6);
    color: var(--color-white);
}

.hero-content {
    display: flex;
    align-items: center;
    gap: var(--space-4);
}

.user-avatar {
    width: 56px;
    height: 56px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.user-avatar svg {
    width: 32px;
    height: 32px;
}

.user-info h1 {
    margin: 0 0 var(--space-1) 0;
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
}

.user-info p {
    margin: 0;
    font-size: var(--text-sm);
    opacity: 0.9;
    line-height: 1.4;
}

.role-collection {
    display: flex;
    gap: var(--space-2);
    margin: var(--space-2) 0;
    flex-wrap: wrap;
}

.role-chip {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    background: rgba(255, 255, 255, 0.2);
    color: var(--color-white);
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.role-chip.active {
    background: var(--color-white);
    color: var(--color-primary);
    transform: scale(1.05);
}

.modern-tabs-container {
    background: var(--color-white);
}

.modern-tabs-nav {
    display: flex;
    background: var(--color-gray-50);
    border-bottom: 1px solid var(--color-gray-200);
}

.modern-tab-button {
    flex: 1;
    padding: var(--space-3) var(--space-4);
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: var(--space-3);
    transition: all var(--transition-base);
    border-bottom: 3px solid transparent;
}

.modern-tab-button:hover {
    background: var(--color-gray-100);
}

.modern-tab-button.active {
    background: var(--color-white);
    border-bottom-color: var(--color-primary);
}

.tab-icon {
    width: 36px;
    height: 36px;
    background: var(--color-gray-200);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all var(--transition-base);
}

.tab-icon svg {
    width: 20px;
    height: 20px;
}

.modern-tab-button.active .tab-icon {
    background: var(--color-primary);
    color: var(--color-white);
}

.tab-text {
    text-align: left;
}

.tab-title {
    display: block;
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    color: var(--color-gray-800);
    margin-bottom: var(--space-1);
}

.tab-subtitle {
    display: block;
    font-size: var(--text-sm);
    color: var(--color-gray-500);
}

.modern-tab-content {
    display: none;
    padding: var(--space-4) var(--space-4);
}

.modern-tab-content.active {
    display: block;
}

.modern-form {
    max-width: 100%;
}

.form-section-modern {
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-3);
    border-bottom: 1px solid var(--color-gray-100);
}

.form-section-modern:last-of-type {
    border-bottom: none;
    margin-bottom: var(--space-2);
}

.section-header {
    margin-bottom: var(--space-3);
}

.section-title {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-base);
    font-weight: var(--font-bold);
    color: var(--color-gray-900);
    margin: 0;
}

.section-title svg {
    width: 20px;
    height: 20px;
}

.section-description {
    display: none;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-4);
}

.address-grid {
    grid-template-columns: 1fr 1fr;
}

.form-group {
    margin-bottom: var(--space-2);
}

.form-label {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-weight: var(--font-semibold);
    color: var(--color-gray-800);
    margin-bottom: var(--space-1);
    font-size: var(--text-sm);
}

.form-label svg {
    width: 16px;
    height: 16px;
}

.form-label.required::after {
    content: ' *';
    color: var(--color-error);
}

.form-input,
.form-select,
.form-textarea {
    width: 100%;
    padding: var(--space-2) var(--space-3);
    border: 1px solid var(--color-gray-300);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    transition: all var(--transition-base);
    background: var(--color-white);
    color: var(--color-gray-900);
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
}

.form-textarea {
    min-height: 80px;
    resize: vertical;
    font-family: inherit;
}

.form-hint {
    display: none;
}

.brewery-selection-section {
    text-align: center;
    padding: var(--space-12) var(--space-8);
    background: var(--color-gray-50);
    border-radius: var(--radius-xl);
    margin-bottom: var(--space-8);
}

.selection-header {
    margin-bottom: var(--space-8);
}

.selection-header svg {
    color: var(--color-primary);
    margin-bottom: var(--space-4);
}

.selection-header h2 {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--color-gray-900);
    margin: 0 0 var(--space-3) 0;
}

.selection-header p {
    color: var(--color-gray-600);
    font-size: var(--text-base);
    line-height: 1.6;
    margin: 0;
}

.contact-admin {
    background: var(--color-white);
    padding: var(--space-6);
    border-radius: var(--radius-xl);
    border: 1px solid var(--color-gray-200);
    margin-top: var(--space-8);
}

.contact-admin svg {
    color: var(--color-info);
    margin-bottom: var(--space-3);
}

.contact-admin h3 {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--color-gray-900);
    margin: 0 0 var(--space-2) 0;
}

.contact-admin p {
    color: var(--color-gray-600);
    margin: 0 0 var(--space-4) 0;
}

.address-helper {
    margin-top: var(--space-3);
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    cursor: pointer;
    font-size: var(--text-sm);
    color: var(--color-gray-700);
}

.checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin: 0;
}

.checkmark {
    font-size: var(--text-sm);
}

.form-actions {
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-gray-100);
    text-align: center;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    border: none;
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    text-decoration: none;
    cursor: pointer;
    transition: all var(--transition-base);
    text-align: center;
}

.btn-primary {
    background: var(--color-primary);
    color: var(--color-white);
}

.btn-primary:hover {
    background: #3730a3;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-secondary {
    background: var(--color-secondary);
    color: var(--color-white);
}

.btn-secondary:hover {
    background: #4b5563;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-large {
    padding: var(--space-3) var(--space-6);
    font-size: var(--text-base);
}

.alert {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    margin: var(--space-3) var(--space-6);
    border-radius: var(--radius-lg);
    border-left: 4px solid;
}

.alert-info {
    background: #dbeafe;
    border-color: var(--color-info);
    color: #1e40af;
}

.alert-error {
    background: #fee2e2;
    border-color: var(--color-error);
    color: #991b1b;
}

.alert-success {
    background: #d1fae5;
    border-color: var(--color-success);
    color: #065f46;
}

/* Responsive Design */
@media (max-width: 768px) {
    .complete-profile-container {
        padding: var(--space-3);
    }
    
    .profile-hero {
        padding: var(--space-3) var(--space-4);
    }
    
    .hero-content {
        flex-direction: column;
        text-align: center;
        gap: var(--space-3);
    }
    
    .modern-tabs-nav {
        flex-direction: row;
        overflow-x: auto;
    }
    
    .modern-tab-button {
        justify-content: center;
        padding: var(--space-2) var(--space-3);
        min-width: 0;
        flex: 1;
    }
    
    .tab-text {
        display: none;
    }
    
    .tab-icon {
        width: 32px;
        height: 32px;
    }
    
    .modern-tab-content {
        padding: var(--space-4) var(--space-3);
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .address-grid {
        grid-template-columns: 1fr;
    }
    
    .brewery-selection-section {
        padding: var(--space-6) var(--space-4);
    }
}

@media (max-width: 480px) {
    .user-info h1 {
        font-size: var(--text-2xl);
    }
    
    .section-title {
        font-size: var(--text-lg);
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-2);
    }
    
    .form-actions {
        padding: var(--space-6) 0;
    }
    
    .btn-large {
        width: 100%;
        padding: var(--space-4);
    }
}

/* ===== GEOLOCATION PREFERENCES SECTION ===== */
.geolocation-preference-card {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 1px solid #bae6fd;
    border-radius: var(--radius-xl);
    padding: var(--space-6);
}

.preference-status {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-5);
    flex-wrap: wrap;
    gap: var(--space-3);
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    border-radius: 20px;
    font-weight: var(--font-semibold);
    font-size: var(--text-sm);
}

.status-indicator.enabled {
    background: #dcfce7;
    color: #166534;
}

.status-indicator.disabled {
    background: #fee2e2;
    color: #991b1b;
}

.status-indicator.ask-always {
    background: #fef3c7;
    color: #92400e;
}

.status-indicator svg {
    width: 20px;
    height: 20px;
}

.last-updated {
    color: var(--color-gray-500);
    font-size: var(--text-xs);
}

.preference-options {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    margin-bottom: var(--space-5);
}

.radio-option {
    display: flex;
    align-items: flex-start;
    gap: var(--space-3);
    padding: var(--space-4);
    background: var(--color-white);
    border: 2px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-base);
}

.radio-option:hover {
    border-color: var(--color-primary);
    background: #f5f3ff;
}

.radio-option.selected {
    border-color: var(--color-primary);
    background: #f5f3ff;
}

.radio-option input[type="radio"] {
    display: none;
}

.radio-custom {
    width: 20px;
    height: 20px;
    min-width: 20px;
    border: 2px solid var(--color-gray-300);
    border-radius: 50%;
    position: relative;
    transition: all var(--transition-base);
}

.radio-option input[type="radio"]:checked + .radio-custom {
    border-color: var(--color-primary);
}

.radio-option input[type="radio"]:checked + .radio-custom::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 10px;
    height: 10px;
    background: var(--color-primary);
    border-radius: 50%;
}

.radio-content {
    flex: 1;
}

.radio-content strong {
    display: block;
    color: var(--color-gray-900);
    font-size: var(--text-sm);
    margin-bottom: var(--space-1);
}

.radio-content small {
    color: var(--color-gray-500);
    font-size: var(--text-xs);
    line-height: 1.4;
}

.btn-save-location {
    width: 100%;
    justify-content: center;
}

@media (max-width: 480px) {
    .preference-status {
        flex-direction: column;
        align-items: flex-start;
    }
}
</style>

<!-- Modern Profile Management Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeProfileTabs();
    initializeFormValidation();
    initializeAddressHelper();
    initializeImageUpload();
    initializeGeolocationPreference();
});

// Enhanced Tab Management
function showTab(tabName) {
    // Hide all tab contents
    const tabContents = document.querySelectorAll('.modern-tab-content');
    tabContents.forEach(tab => {
        tab.classList.remove('active');
        tab.style.opacity = '0';
        tab.style.transform = 'translateY(10px)';
    });
    
    // Remove active class from all tab buttons
    const tabButtons = document.querySelectorAll('.modern-tab-button');
    tabButtons.forEach(button => {
        button.classList.remove('active');
        const icon = button.querySelector('.tab-icon');
        if (icon) icon.style.background = 'var(--color-gray-200)';
    });
    
    // Show selected tab with animation
    const selectedTab = document.getElementById(tabName + '-tab');
    const selectedButton = document.querySelector(`[data-tab="${tabName}"]`);
    
    if (selectedTab && selectedButton) {
        selectedTab.classList.add('active');
        selectedButton.classList.add('active');
        
        // Animate tab content
        setTimeout(() => {
            selectedTab.style.opacity = '1';
            selectedTab.style.transform = 'translateY(0)';
        }, 50);
        
        // Update button icon
        const icon = selectedButton.querySelector('.tab-icon');
        if (icon) {
            icon.style.background = 'var(--color-primary)';
            icon.style.color = 'var(--color-white)';
        }
    }
}

// Initialize tab system
function initializeProfileTabs() {
    const tabButtons = document.querySelectorAll('.modern-tab-button');
    const tabContents = document.querySelectorAll('.modern-tab-content');
    
    // Add click handlers to tab buttons (no inline onclick needed)
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            if (tabId) {
                showTab(tabId);
            }
        });
    });
    
    // Set initial tab styles
    tabContents.forEach((tab, index) => {
        if (index === 0) {
            tab.style.opacity = '1';
            tab.style.transform = 'translateY(0)';
        } else {
            tab.style.opacity = '0';
            tab.style.transform = 'translateY(10px)';
        }
        tab.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
    });
}

// Enhanced Form Validation
function initializeFormValidation() {
    const forms = document.querySelectorAll('.modern-form');
    
    forms.forEach(form => {
        const inputs = form.querySelectorAll('.form-input, .form-select, .form-textarea');
        
        inputs.forEach(input => {
            // Real-time validation on blur
            input.addEventListener('blur', function() {
                validateInput(this);
            });
            
            // Clear validation on focus
            input.addEventListener('focus', function() {
                clearValidation(this);
            });
        });
        
        // Form submission validation
        form.addEventListener('submit', function(e) {
            let isValid = true;
            const requiredInputs = this.querySelectorAll('[required]');
            
            requiredInputs.forEach(input => {
                if (!validateInput(input)) {
                    isValid = false;
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                showValidationError('Per favore completa tutti i campi obbligatori');
            }
        });
    });
}

function validateInput(input) {
    const value = input.value.trim();
    
    // Clear previous validation
    clearValidation(input);
    
    // Required field validation
    if (input.required && !value) {
        markAsInvalid(input, 'Questo campo è obbligatorio');
        return false;
    }
    
    // Email validation
    if (input.type === 'email' && value && !isValidEmail(value)) {
        markAsInvalid(input, 'Inserisci un\'email valida');
        return false;
    }
    
    // URL validation
    if (input.type === 'url' && value && !isValidUrl(value)) {
        markAsInvalid(input, 'Inserisci un URL valido');
        return false;
    }
    
    // Task 21: Rimossa validazione customerFiscalCode - campo non più presente nel form customer
    // La validazione breweryFiscalCode (P.IVA) rimane per i birrifici
    
    markAsValid(input);
    return true;
}

function markAsInvalid(input, message) {
    input.style.borderColor = 'var(--color-error)';
    input.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
    
    // Add error message
    const errorMsg = document.createElement('small');
    errorMsg.className = 'validation-error';
    errorMsg.style.color = 'var(--color-error)';
    errorMsg.style.fontSize = 'var(--text-xs)';
    errorMsg.style.marginTop = 'var(--space-1)';
    errorMsg.textContent = message;
    
    input.parentNode.appendChild(errorMsg);
}

function markAsValid(input) {
    input.style.borderColor = 'var(--color-success)';
    input.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
}

function clearValidation(input) {
    input.style.borderColor = 'var(--color-gray-300)';
    input.style.boxShadow = 'none';
    
    // Remove error messages
    const errorMsg = input.parentNode.querySelector('.validation-error');
    if (errorMsg) {
        errorMsg.remove();
    }
}

// Address Helper Functions
function initializeAddressHelper() {
    const sameAddressCheckbox = document.getElementById('sameAddress');
    if (sameAddressCheckbox) {
        sameAddressCheckbox.addEventListener('change', copySameAddress);
    }
}

function copySameAddress() {
    const sameAddress = document.getElementById('sameAddress');
    const billingAddress = document.getElementById('billingAddress');
    const shippingAddress = document.getElementById('shippingAddress');
    
    if (sameAddress && billingAddress && shippingAddress) {
        if (sameAddress.checked) {
            shippingAddress.value = billingAddress.value;
            shippingAddress.disabled = true;
            shippingAddress.style.backgroundColor = 'var(--color-gray-100)';
        } else {
            shippingAddress.disabled = false;
            shippingAddress.style.backgroundColor = 'var(--color-white)';
        }
    }
}

// Image Upload Functionality
function initializeImageUpload() {
    const logoInput = document.getElementById('breweryLogo');
    const imagesInput = document.getElementById('breweryImages');
    
    if (logoInput) {
        logoInput.addEventListener('change', handleLogoUpload);
    }
    
    if (imagesInput) {
        imagesInput.addEventListener('change', handleImagesUpload);
    }
}

function handleLogoUpload(e) {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            updateLogoPreview(e.target.result);
        };
        reader.readAsDataURL(file);
    }
}

function handleImagesUpload(e) {
    const files = Array.from(e.target.files);
    files.forEach(file => {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                addImagePreview(e.target.result);
            };
            reader.readAsDataURL(file);
        }
    });
}

function updateLogoPreview(src) {
    let preview = document.querySelector('.brewery-logo-preview');
    if (!preview) {
        preview = document.createElement('img');
        preview.className = 'brewery-logo-preview';
        preview.style.maxWidth = '200px';
        preview.style.marginTop = 'var(--space-4)';
        preview.style.borderRadius = 'var(--radius-lg)';
        preview.style.boxShadow = 'var(--shadow-md)';
        
        const uploadSection = document.querySelector('.file-upload').parentNode;
        uploadSection.insertBefore(preview, uploadSection.querySelector('.file-upload'));
    }
    preview.src = src;
}

function addImagePreview(src) {
    // Implementation for image gallery preview
    console.log('Adding image preview:', src);
}

// Utility Functions
function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function isValidUrl(url) {
    try {
        new URL(url);
        return true;
    } catch {
        return false;
    }
}

function isValidFiscalCode(code) {
    // Simplified Italian fiscal code validation
    return /^[A-Z]{6}\d{2}[A-Z]\d{2}[A-Z]\d{3}[A-Z]$/i.test(code);
}

function showValidationError(message) {
    // Create toast notification for validation errors
    const toast = document.createElement('div');
    toast.className = 'validation-toast';
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--color-error);
        color: white;
        padding: var(--space-4) var(--space-6);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-xl);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

// CSS Animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Geolocation Preference Management
function initializeGeolocationPreference() {
    const saveBtn = document.getElementById('saveLocationPreference');
    const radioOptions = document.querySelectorAll('input[name="locationConsentOption"]');
    const radioLabels = document.querySelectorAll('.radio-option');
    
    if (!saveBtn) return;
    
    // Update visual state when radio changes
    radioOptions.forEach(radio => {
        radio.addEventListener('change', function() {
            radioLabels.forEach(label => label.classList.remove('selected'));
            this.closest('.radio-option').classList.add('selected');
        });
    });
    
    // Save preference
    saveBtn.addEventListener('click', async function() {
        const selectedOption = document.querySelector('input[name="locationConsentOption"]:checked');
        if (!selectedOption) {
            showGeolocationToast('Seleziona un\'opzione prima di salvare', 'error');
            return;
        }
        
        let enabled;
        let rememberChoice = true;
        
        switch (selectedOption.value) {
            case 'enabled':
                enabled = true;
                break;
            case 'disabled':
                enabled = false;
                break;
            case 'ask':
            default:
                enabled = null;
                rememberChoice = false; // null = chiedi ogni volta
                break;
        }
        
        saveBtn.disabled = true;
        saveBtn.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="spin">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10" stroke="currentColor" stroke-width="2" fill="none"/>
            </svg>
            Salvataggio...
        `;
        
        try {
            const response = await fetch('/api/user/location-consent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    enabled: enabled !== null ? enabled : false,
                    rememberChoice: rememberChoice 
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showGeolocationToast('Preferenza salvata con successo!', 'success');
                updateStatusIndicator(selectedOption.value);
            } else {
                throw new Error(data.error || 'Errore nel salvataggio');
            }
        } catch (error) {
            console.error('Errore salvataggio preferenza:', error);
            showGeolocationToast('Errore nel salvataggio della preferenza', 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" fill="currentColor"/>
                </svg>
                Salva Preferenza
            `;
        }
    });
}

function updateStatusIndicator(value) {
    const indicator = document.querySelector('.status-indicator');
    if (!indicator) return;
    
    indicator.className = 'status-indicator';
    
    if (value === 'enabled') {
        indicator.classList.add('enabled');
        indicator.innerHTML = `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="currentColor"/>
            </svg>
            <span>Abilitata</span>
        `;
    } else if (value === 'disabled') {
        indicator.classList.add('disabled');
        indicator.innerHTML = `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="currentColor"/>
            </svg>
            <span>Disabilitata</span>
        `;
    } else {
        indicator.classList.add('ask-always');
        indicator.innerHTML = `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" fill="currentColor"/>
            </svg>
            <span>Chiedi ogni volta</span>
        `;
    }
    
    // Aggiorna anche l'orario
    const lastUpdated = document.querySelector('.last-updated');
    if (lastUpdated) {
        const now = new Date();
        lastUpdated.textContent = `Ultimo aggiornamento: ${now.toLocaleString('it-IT')}`;
    }
}

function showGeolocationToast(message, type) {
    const toast = document.createElement('div');
    toast.className = 'geolocation-toast';
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : '#ef4444'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    `;
    
    const icon = type === 'success' 
        ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="currentColor"/></svg>'
        : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" fill="currentColor"/></svg>';
    
    toast.innerHTML = icon + message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}
</script>
{% endblock %}
