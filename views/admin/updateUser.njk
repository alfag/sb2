{% extends "../layout.njk" %}

{% block title %}Modifica Utente{% endblock %}

{% block content %}
<div class="container">
    <h1>Modifica Utente</h1>
    {% if not userToEdit %}
        <form method="get" action="/administrator/users/update">
            <div class="form-group">
                <label for="userUpdateId">Seleziona utente:</label>
                <select id="userUpdateId" name="userUpdateId" required>
                    <option value="">-- Seleziona --</option>
                    {% for u in users %}
                        <option value="{{ u._id }}">{{ u.username }} ({{ u.role }})</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit">Modifica</button>
        </form>
    {% else %}
        <form id="updateUserForm" method="post" action="/administrator/users/update/{{ userToEdit._id }}">
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" value="{{ userToEdit.username }}" required>
            </div>
            <div class="form-group">
                <label for="password">Nuova Password (lascia vuoto per non cambiare):</label>
                <input type="password" id="password" name="password" autocomplete="new-password">
            </div>
            <div class="form-group">
                <label>Ruoli attuali:</label>
                <ul>
                    {% for r in userToEdit.role %}
                        <li>
                            {{ r|capitalize }}
                            <form method="post" action="/administrator/users/removeRole/{{ userToEdit._id }}" style="display:inline;">
                                <input type="hidden" name="roleToRemove" value="{{ r }}">
                                <button type="submit" class="remove-role-btn" data-role="{{ r }}">Rimuovi</button>
                            </form>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="form-group">
                <label for="addRole">Aggiungi ruolo:</label>
                <form method="post" action="/administrator/users/addRole/{{ userToEdit._id }}" style="display:flex; gap:8px;">
                    <select id="addRole" name="roleToAdd">
                        <option value="">-- Seleziona --</option>
                        {% for r in ['customer','brewery','administrator'] if r not in userToEdit.role %}
                            <option value="{{ r }}">{{ r|capitalize }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit">Aggiungi</button>
                </form>
            </div>
            {% if 'customer' in userToEdit.role %}
            <div id="customerDetails" class="roleDetails">
                <h2>Dettagli Customer</h2>
                <div class="form-group">
                    <label for="customerName">Nome:</label>
                    <input type="text" id="customerName" name="customerName" value="{{ userToEdit.customerDetails.customerName }}">
                </div>
                <div class="form-group">
                    <label for="customerSurname">Cognome:</label>
                    <input type="text" id="customerSurname" name="customerSurname" value="{{ userToEdit.customerDetails.customerSurname }}">
                </div>
                <div class="form-group">
                    <label for="customerFiscalCode">Codice Fiscale:</label>
                    <input type="text" id="customerFiscalCode" name="customerFiscalCode" value="{{ userToEdit.customerDetails.customerFiscalCode }}">
                </div>
                <div class="form-group">
                    <label for="customerBillingAddress">Indirizzo di Fatturazione:</label>
                    <input type="text" id="customerBillingAddress" name="customerBillingAddress" value="{{ userToEdit.customerDetails.customerAddresses.billingAddress }}">
                </div>
                <div class="form-group">
                    <label for="customerShippingAddress">Indirizzo di Spedizione:</label>
                    <input type="text" id="customerShippingAddress" name="customerShippingAddress" value="{{ userToEdit.customerDetails.customerAddresses.shippingAddress }}">
                </div>
                <div class="form-group">
                    <label for="customerPhoneNumber">Numero di Telefono:</label>
                    <input type="text" id="customerPhoneNumber" name="customerPhoneNumber" value="{{ userToEdit.customerDetails.customerPhoneNumber }}">
                </div>
            </div>
            {% endif %}
            {% if 'administrator' in userToEdit.role %}
            <div id="administratorDetails" class="roleDetails">
                <h2>Dettagli Administrator</h2>
                <div class="form-group">
                    <label for="administratorName">Nome Administrator:</label>
                    <input type="text" id="administratorName" name="administratorName" value="{{ userToEdit.administratorDetails.administratorName }}">
                </div>
                <div class="form-group">
                    <label for="administratorPermission">Permessi:</label>
                    <input type="text" id="administratorPermission" name="administratorPermission" value="{{ userToEdit.administratorDetails.administratorPermission }}">
                </div>
            </div>
            {% endif %}
            {% if 'brewery' in userToEdit.role %}
            <div id="breweryDetails" class="roleDetails">
                <h2>Dettagli Brewery</h2>
                <div class="form-group">
                    <label for="breweryName">Nome Birrificio:</label>
                    <input type="text" id="breweryName" name="breweryName" value="{{ userToEdit.breweryDetails.breweryName }}">
                </div>
                <div class="form-group">
                    <label for="breweryDescription">Descrizione Birrificio:</label>
                    <textarea id="breweryDescription" name="breweryDescription">{{ userToEdit.breweryDetails.breweryDescription }}</textarea>
                </div>
                <div class="form-group">
                    <label for="breweryFiscalCode">Codice Fiscale Birrificio:</label>
                    <input type="text" id="breweryFiscalCode" name="breweryFiscalCode" value="{{ userToEdit.breweryDetails.breweryFiscalCode }}">
                </div>
            </div>
            {% endif %}
            <button type="submit">Salva Modifiche</button>
        </form>
        <form id="deleteUserForm" method="post" action="/administrator/users/delete/{{ userToEdit._id }}" style="margin-top: 16px;">
            <button type="button" id="deleteUserBtn" style="background-color: #c00; color: #fff;">Elimina Utente</button>
        </form>
    {% endif %}
</div>
{% endblock %}
<script src="/js/updateUser.js"></script>