{% extends "../layout.njk" %}

{% block title %}Gestione Recensioni - Admin{% endblock %}

{% block head %}
<link rel="stylesheet" href="/css/admin-dashboard.css?t=20251229k">
<style>
/* ===== LOADING OVERLAY ===== */
.filter-loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(4px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.15s ease;
}
.filter-loading-overlay.active {
    display: flex;
    opacity: 1;
}
.filter-spinner {
    width: 48px;
    height: 48px;
    border: 4px solid #e5e7eb;
    border-top-color: #f59e0b;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}
.filter-loading-text {
    position: absolute;
    margin-top: 80px;
    font-size: 0.875rem;
    color: #6b7280;
    font-weight: 500;
}

/* ===== SEZIONE AI PROCESSING STAT BOXES ===== */
.stats-row-ai {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.4rem;
    padding: 0.4rem 1rem 0.6rem;
    background: linear-gradient(180deg, rgba(241,245,249,0.5) 0%, rgba(248,250,252,0.3) 100%);
}
.stats-row-ai .stat-box {
    border-left: 3px solid var(--box-color, var(--dash-blue));
}

/* Label sezione filtri */
.filter-section-label {
    padding: 0.4rem 1rem 0;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #64748b;
    display: flex;
    align-items: center;
    gap: 0.4rem;
}
.filter-section-label i {
    font-size: 0.6rem;
}

/* Search box per autocomplete - stile identico a breweries */
.review-search-box {
    position: relative;
    margin: 0 1rem 8px;
}
.review-search-box input {
    width: 100%;
    padding: 12px 16px 12px 44px;
    font-size: 15px;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    background: #fff;
    color: #1f2937;
    transition: all 0.2s ease;
}
.review-search-box input:focus {
    outline: none;
    border-color: #f59e0b;
    box-shadow: 0 0 0 3px rgba(245,158,11,0.15);
}
.review-search-box input::placeholder {
    color: #9ca3af;
}
.review-search-box .search-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    font-size: 14px;
}
.review-search-box .clear-search {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #9ca3af;
    cursor: pointer;
    padding: 4px;
    display: none;
}
.review-search-box .clear-search:hover {
    color: #ef4444;
}
.review-search-box.has-value .clear-search {
    display: block;
}

/* ========== HIDDEN REVIEW CARD STYLE ========== */
.review-item.is-hidden {
    position: relative;
    opacity: 0.6;
    border-color: #d1d5db;
    background: #f9fafb;
}
.review-item.is-hidden:hover {
    opacity: 0.85;
}
.hidden-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.2rem;
    background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
    color: white;
    font-size: 0.55rem;
    font-weight: 700;
    padding: 0.2rem 0.5rem;
    border-radius: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 6px rgba(229, 57, 53, 0.3);
    flex-shrink: 0;
}
.hidden-badge i {
    font-size: 0.5rem;
}

/* Reviews List - Stile card identico a breweries/beers */
.review-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    padding: 0 1rem;
    margin-bottom: 2rem;
}

.review-item {
    position: relative;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 14px;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.review-item:hover {
    background: #fffbeb;
    border-color: #f59e0b;
    box-shadow: 0 2px 8px rgba(245,158,11,0.15);
}

/* Thumbnail con bordo gradient ambra/dorato */
.review-thumb {
    width: 52px;
    height: 52px;
    flex-shrink: 0;
    border-radius: 8px;
    overflow: hidden;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%);
    padding: 2px;
}
.review-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 6px;
    display: block;
}
.review-thumb .no-photo {
    width: 100%;
    height: 100%;
    border-radius: 6px;
    background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #bbb;
    font-size: 1.1rem;
}

/* Review Content */
.review-info {
    flex: 1;
    min-width: 0;
}
.review-beer-name {
    font-size: 14px;
    font-weight: 600;
    color: #1f2937;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
}
.review-brewery-name {
    font-size: 12px;
    color: #6b7280;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
    margin-top: 1px;
}
.review-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
    font-size: 11px;
    color: #9ca3af;
    margin-top: 3px;
}
.review-meta-item {
    display: flex;
    align-items: center;
    gap: 3px;
}
.review-meta-item i { font-size: 10px; }
.review-meta-item.user i { color: #f59e0b; }
.review-meta-item.date i { color: #10b981; }

/* User banned indicator */
.user-banned { color: #d32f2f; font-weight: 600; }
.user-banned i { margin-right: 2px; }

/* Rating Display */
.review-rating {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    padding: 0 0.35rem;
    flex-shrink: 0;
}
.stars {
    display: flex;
    gap: 1px;
}
.stars i {
    font-size: 11px;
    color: #ffc107;
}
.stars i.empty { color: #e0e0e0; }
.rating-value-text {
    font-size: 10px;
    color: #999;
    font-style: italic;
}

/* Status Badges Container */
.review-badges {
    display: flex;
    flex-direction: column;
    gap: 3px;
    align-items: flex-start;
    flex-shrink: 0;
}

/* Status Badge - Moderazione */
.review-status {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    white-space: nowrap;
}
.status-pending { background: #fff3e0; color: #f57c00; }
.status-validated { background: #e3f2fd; color: #1976d2; }
.status-completed { background: #e8f5e9; color: #388e3c; }
.status-hidden { background: #f5f5f5; color: #757575; }
.status-flagged { background: #ffebee; color: #d32f2f; }
.status-needs_admin { background: #fce4ec; color: #c2185b; }

/* Processing Status Badge - AI Elaborazione */
.processing-status {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.15rem 0.45rem;
    border-radius: 10px;
    font-size: 0.6rem;
    font-weight: 500;
    white-space: nowrap;
}
.processing-pending_validation {
    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    color: #c0392b;
}
.processing-processing {
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    color: #8e44ad;
}
.processing-completed {
    background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
    color: #27ae60;
}
.processing-failed {
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
    color: #c0392b;
}
.processing-needs_admin_review {
    background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
    color: #8e44ad;
}

/* AI Processing Animation */
.processing-status.is-processing {
    animation: pulse-processing 1.5s ease-in-out infinite;
}
.processing-status .ai-spinner {
    width: 10px;
    height: 10px;
    border: 2px solid currentColor;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
@keyframes pulse-processing {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(1.02); }
}
@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Admin Actions - Icon buttons inline */
.review-admin-actions {
    display: flex;
    align-items: center;
    gap: 4px;
    flex-shrink: 0;
}
.btn-icon {
    width: 30px;
    height: 30px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s ease;
    font-size: 12px;
}
.btn-icon:hover { transform: scale(1.1); }
.btn-icon.view { background: #e3f2fd; color: #1976d2; }
.btn-icon.view:hover { background: #1976d2; color: white; }
.btn-icon.validate { background: #e8f5e9; color: #388e3c; }
.btn-icon.validate:hover { background: #388e3c; color: white; }
.btn-icon.hide { background: #fff3e0; color: #f57c00; }
.btn-icon.hide:hover { background: #f57c00; color: white; }
.btn-icon.flag { background: #ffebee; color: #d32f2f; }
.btn-icon.flag:hover { background: #d32f2f; color: white; }
.btn-icon.ban { background: #fce4ec; color: #c2185b; }
.btn-icon.ban:hover { background: #c2185b; color: white; }
.btn-icon.unban { background: #e8f5e9; color: #2e7d32; }
.btn-icon.unban:hover { background: #2e7d32; color: white; }
.btn-icon.delete { background: #ffcdd2; color: #b71c1c; }
.btn-icon.delete:hover { background: #b71c1c; color: white; }
.btn-icon.edit { background: #e8eaf6; color: #3f51b5; }
.btn-icon.edit:hover { background: #3f51b5; color: white; }

/* ===== EDIT REVIEW MODAL STYLES ===== */
.edit-form-group {
    margin-bottom: 0.75rem;
}
.edit-form-group label {
    display: block;
    font-size: 0.75rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}
.edit-form-group label i {
    margin-right: 4px;
    color: #6b7280;
    font-size: 0.7rem;
}
.edit-form-input,
.edit-form-select,
.edit-form-textarea {
    width: 100%;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    background: #fff;
    color: #1f2937;
    transition: all 0.2s ease;
    box-sizing: border-box;
}
.edit-form-input:focus,
.edit-form-select:focus,
.edit-form-textarea:focus {
    outline: none;
    border-color: #3f51b5;
    box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.15);
}
.edit-form-textarea {
    min-height: 80px;
    resize: vertical;
}
.edit-form-select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
}
.edit-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
}
.edit-rating-display {
    padding: 0.5rem 0.75rem;
    background: linear-gradient(135deg, #fff8e1, #fff);
    border: 1px solid #ffc107;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.edit-rating-display .stars i {
    font-size: 1rem;
    color: #ffc107;
}
.edit-rating-display .stars i.empty {
    color: #e0e0e0;
}
.edit-rating-lock {
    font-size: 0.65rem;
    color: #9ca3af;
    font-style: italic;
    display: flex;
    align-items: center;
    gap: 3px;
}
.edit-rating-lock i {
    font-size: 0.55rem;
}
.edit-section-divider {
    font-size: 0.65rem;
    font-weight: 700;
    color: white;
    margin: 0.75rem -1rem;
    padding: 0.3rem 1rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 0.3rem;
}
.edit-section-divider.beer-section {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}
.edit-section-divider.brewery-section {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}
.edit-section-divider.notes-section {
    background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
}
/* ===== SEARCHABLE SELECT COMPONENT ===== */
.searchable-select {
    position: relative;
}
.searchable-select-input {
    width: 100%;
    padding: 0.5rem 2.2rem 0.5rem 0.75rem;
    font-size: 0.875rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    background: #fff;
    color: #1f2937;
    transition: all 0.2s ease;
    box-sizing: border-box;
}
.searchable-select-input:focus {
    outline: none;
    border-color: #3f51b5;
    box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.15);
}
.searchable-select-input::placeholder {
    color: #9ca3af;
}
.searchable-select-chevron {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
    font-size: 0.65rem;
    pointer-events: none;
    transition: transform 0.2s;
}
.searchable-select.open .searchable-select-chevron {
    transform: translateY(-50%) rotate(180deg);
}
.searchable-select-clear {
    position: absolute;
    right: 28px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #9ca3af;
    cursor: pointer;
    font-size: 0.7rem;
    padding: 2px 4px;
    display: none;
    line-height: 1;
}
.searchable-select-clear:hover { color: #ef4444; }
.searchable-select.has-value .searchable-select-clear { display: block; }
.searchable-select-dropdown {
    position: absolute;
    top: calc(100% + 2px);
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 50;
    display: none;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
}
.searchable-select.open .searchable-select-dropdown {
    display: block;
}
.searchable-select-item {
    padding: 0.45rem 0.75rem;
    font-size: 0.8rem;
    cursor: pointer;
    border-bottom: 1px solid #f3f4f6;
    transition: background 0.1s;
    display: flex;
    flex-direction: column;
}
.searchable-select-item:last-child { border-bottom: none; }
.searchable-select-item:hover,
.searchable-select-item.highlighted {
    background: #fffbeb;
}
.searchable-select-item.selected {
    background: #eef2ff;
    font-weight: 600;
}
.searchable-select-item .item-main {
    font-weight: 500;
    color: #1f2937;
}
.searchable-select-item .item-sub {
    font-size: 0.65rem;
    color: #6b7280;
    margin-top: 1px;
}
.searchable-select-item .item-main mark {
    background: #fef3c7;
    color: #92400e;
    border-radius: 2px;
    padding: 0 1px;
}
.searchable-select-empty {
    padding: 0.75rem;
    text-align: center;
    color: #9ca3af;
    font-size: 0.8rem;
    font-style: italic;
}
.searchable-select-count {
    padding: 0.3rem 0.75rem;
    font-size: 0.6rem;
    color: #9ca3af;
    text-align: right;
    border-top: 1px solid #f3f4f6;
    background: #fafafa;
    border-radius: 0 0 8px 8px;
}
.edit-modal-footer {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
    padding-top: 0.75rem;
    border-top: 1px solid #f0f0f0;
    margin-top: 0.75rem;
}
.btn-edit-save {
    padding: 0.6rem 1.5rem;
    border-radius: 10px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    border: none;
    background: linear-gradient(135deg, #3f51b5, #1a237e);
    color: white;
    transition: all 0.2s;
}
.btn-edit-save:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(63, 81, 181, 0.3);
}
.btn-edit-save:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}
.btn-edit-cancel {
    padding: 0.6rem 1.25rem;
    border-radius: 10px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
    background: linear-gradient(135deg, #f5f7fa, #e4e8eb);
    color: #666;
    transition: all 0.2s;
}
.btn-edit-cancel:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}
@media (max-width: 640px) {
    .edit-form-row {
        grid-template-columns: 1fr;
    }
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem;
    color: #888;
    background: white;
    border-radius: 12px;
}
.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}
.empty-state h3 {
    font-size: 1.1rem;
    color: #555;
    margin-bottom: 0.5rem;
}
.empty-state p {
    font-size: 0.875rem;
    color: #888;
}

/* Modal */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.25s ease;
}
.modal-overlay.active { display: flex; opacity: 1; }
.modal-content {
    background: white;
    border-radius: 12px;
    padding: 1rem;
    max-width: 600px;
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    transform: scale(0.95) translateY(10px);
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.25s ease;
    opacity: 0;
}
.modal-overlay.active .modal-content {
    transform: scale(1) translateY(0);
    opacity: 1;
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: -1rem -1rem 0.75rem -1rem;
    padding: 0.75rem 1rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px 12px 0 0;
}
.modal-title {
    font-size: 1rem;
    font-weight: 600;
    color: white;
    display: flex;
    align-items: center;
    gap: 0.4rem;
}
.modal-title i { font-size: 0.9rem; }
.modal-close {
    background: rgba(255,255,255,0.2);
    border: none;
    font-size: 1.1rem;
    cursor: pointer;
    color: white;
    padding: 0.2rem 0.4rem;
    line-height: 1;
    border-radius: 4px;
    transition: all 0.2s;
}
.modal-close:hover { background: rgba(255,255,255,0.3); }
.modal-body { margin-bottom: 0.5rem; }
.modal-footer {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
    padding-top: 0.5rem;
    border-top: 1px solid #f0f0f0;
}
.btn-modal {
    padding: 0.6rem 1.25rem;
    border-radius: 10px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
}
.btn-modal.cancel { 
    background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%); 
    color: #666; 
}
.btn-modal.confirm { 
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%); 
    color: white; 
}
.btn-modal:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }

/* Detail Modal - Compact Cool Design */
.detail-section { 
    margin-bottom: 0.5rem;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 0.5rem;
    border: 1px solid #eef1f5;
}
.detail-section h4 {
    font-size: 0.65rem;
    font-weight: 700;
    color: white;
    margin: -0.5rem -0.5rem 0.4rem -0.5rem;
    padding: 0.35rem 0.6rem;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    border-radius: 8px 8px 0 0;
    display: flex;
    align-items: center;
    gap: 0.3rem;
}
.detail-section h4 i { font-size: 0.6rem; }
.detail-section:nth-child(1) h4 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.detail-section:nth-child(2) h4 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
.detail-section:nth-child(3) h4 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
.detail-section:nth-child(4) h4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
.detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.25rem 0;
    border-bottom: 1px dashed #e0e5eb;
    font-size: 0.8rem;
}
.detail-row:last-child { border-bottom: none; }
.detail-label { color: #666; font-size: 0.75rem; }
.detail-value { color: #333; font-weight: 600; text-align: right; }
.detail-notes {
    background: white;
    border-radius: 6px;
    padding: 0.5rem;
    font-size: 0.8rem;
    color: #555;
    line-height: 1.4;
    border: 1px solid #e0e5eb;
    max-height: 60px;
    overflow-y: auto;
}
.detailed-ratings-grid {
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    gap: 0.3rem !important;
}
.detailed-rating-item {
    background: white;
    border-radius: 6px;
    padding: 0.35rem 0.3rem;
    text-align: center;
    border: 1px solid #e0e5eb;
    min-width: 0;
    overflow: hidden;
}
.detailed-rating-item.overall {
    grid-column: 1 / -1 !important;
    background: linear-gradient(135deg, #fff8e1 0%, #fff 100%);
    border-color: #ffc107;
}
.detailed-rating-label {
    font-size: 0.55rem;
    color: #888;
    text-transform: uppercase;
    margin-bottom: 0.15rem;
    letter-spacing: 0.2px;
}
.detailed-rating-item.overall .detailed-rating-label {
    color: #e6a000;
    font-weight: 600;
}
.rating-stars-display {
    display: flex;
    gap: 0.15rem;
    justify-content: center;
    font-size: 0.9rem;
}
.rating-stars-display .fa-star { color: #ffc107; }
.rating-stars-display .fa-star.empty { color: #e0e0e0; }
.not-rated-label {
    color: #999;
    font-style: italic;
    font-size: 0.75rem;
}
.mini-stars { font-size: 0.5rem; display: flex; gap: 1px; justify-content: center; margin-top: 2px; }
.mini-stars .fa-star { color: #ffc107; }
.mini-stars .fa-star.empty { color: #ddd; }

/* Pagination */
.pagination {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 1.5rem;
    padding: 0 1rem;
}
.pagination a, .pagination span {
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    font-size: 0.875rem;
    text-decoration: none;
    transition: all 0.2s;
}
.pagination a {
    background: white;
    color: #f59e0b;
    border: 1px solid #e0e0e0;
}
.pagination a:hover {
    background: #f59e0b;
    color: white;
    border-color: #f59e0b;
}
.pagination span.current {
    background: #f59e0b;
    color: white;
}
.pagination span.disabled {
    background: #f5f5f5;
    color: #ccc;
}

/* No results message */
.no-filter-results {
    text-align: center;
    padding: 2rem 1rem;
    color: #64748b;
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    border-radius: 10px;
    margin: 0 1rem 1rem;
    display: none;
}
.no-filter-results.visible { display: block; }
.no-filter-results i { font-size: 2rem; margin-bottom: 0.5rem; color: #f59e0b; }
.no-filter-results p { font-size: 0.85rem; margin: 0; }

/* Responsive */
@media (max-width: 640px) {
    .review-item { padding: 10px; gap: 8px; flex-wrap: wrap; }
    .review-thumb { width: 44px; height: 44px; }
    .review-beer-name { font-size: 13px; }
    .review-badges { flex-direction: row; gap: 4px; }
    .review-admin-actions {
        width: 100%;
        justify-content: flex-end;
        padding-top: 6px;
        border-top: 1px solid #f3f4f6;
        margin-top: 4px;
    }
    .btn-icon { width: 28px; height: 28px; font-size: 11px; }
    .stats-row, .stats-row-ai { grid-template-columns: repeat(3, 1fr); }
    .search-filters-grid { grid-template-columns: 1fr; }
}
</style>
{% endblock %}

{% block content %}
<div class="admin-page">
    <!-- Header - Stile identico a breweries/beers -->
    <div class="page-head">
        <div class="page-head-left">
            <h1><i class="fas fa-star"></i> Gestione Recensioni</h1>
            <span class="head-count">{{ stats.total or 0 }} recensioni</span>
        </div>
    </div>

    <!-- ===== FILTRI MODERAZIONE - Stats Row ===== -->
    <div class="filter-section-label">
        <i class="fas fa-shield-alt"></i> Moderazione
    </div>
    <div class="stats-row">
        <div class="stat-box amber review-filter-card active" data-filter="all">
            <i class="fas fa-star"></i>
            <span class="val">{{ stats.total or 0 }}</span><span class="lbl">Tutte</span>
        </div>
        <div class="stat-box amber review-filter-card" data-filter="pending">
            <i class="fas fa-clock"></i>
            <span class="val">{{ stats.pending or 0 }}</span><span class="lbl">Attesa</span>
        </div>
        <div class="stat-box green review-filter-card" data-filter="validated">
            <i class="fas fa-check"></i>
            <span class="val">{{ stats.validated or 0 }}</span><span class="lbl">Validate</span>
        </div>
        <div class="stat-box blue review-filter-card" data-filter="completed">
            <i class="fas fa-check-double"></i>
            <span class="val">{{ stats.completed or 0 }}</span><span class="lbl">Complete</span>
        </div>
        <div class="stat-box indigo review-filter-card" data-filter="hidden">
            <i class="fas fa-eye-slash"></i>
            <span class="val">{{ stats.hidden or 0 }}</span><span class="lbl">Nascoste</span>
        </div>
        <div class="stat-box red review-filter-card" data-filter="flagged">
            <i class="fas fa-flag"></i>
            <span class="val">{{ stats.flagged or 0 }}</span><span class="lbl">Segnalate</span>
        </div>
        <div class="stat-box purple review-filter-card" data-filter="needs_admin">
            <i class="fas fa-exclamation-triangle"></i>
            <span class="val">{{ stats.needsAdmin or 0 }}</span><span class="lbl">Verifica</span>
        </div>
        <div class="stat-box red review-filter-card" data-filter="banned_users">
            <i class="fas fa-ban"></i>
            <span class="val">{{ stats.bannedUsers or 0 }}</span><span class="lbl">Bannati</span>
        </div>
    </div>

    <!-- ===== FILTRI AI PROCESSING ===== -->
    <div class="filter-section-label">
        <i class="fas fa-robot"></i> Elaborazione
    </div>
    <div class="stats-row-ai">
        <div class="stat-box cyan ai-filter-card" data-processing-filter="pending_validation">
            <i class="fas fa-inbox"></i>
            <span class="val">{{ stats.aiPending or 0 }}</span><span class="lbl">Coda</span>
        </div>
        <div class="stat-box blue ai-filter-card" data-processing-filter="processing">
            <i class="fas fa-cog fa-spin"></i>
            <span class="val">{{ stats.aiProcessing or 0 }}</span><span class="lbl">Elabora</span>
        </div>
        <div class="stat-box green ai-filter-card" data-processing-filter="ai_completed">
            <i class="fas fa-check-circle"></i>
            <span class="val">{{ stats.aiCompleted or 0 }}</span><span class="lbl">OK</span>
        </div>
        <div class="stat-box red ai-filter-card" data-processing-filter="failed">
            <i class="fas fa-times-circle"></i>
            <span class="val">{{ stats.aiFailed or 0 }}</span><span class="lbl">Fallite</span>
        </div>
    </div>

    <!-- Search Box - Stile identico a breweries -->
    <div class="review-search-box" id="reviewSearchBox">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="reviewSearchInput" placeholder="Cerca birra, birrificio o utente..." autocomplete="off" oninput="handleQuickSearch(this)">
        <button class="clear-search" onclick="clearQuickSearch()" title="Cancella"><i class="fas fa-times"></i></button>
    </div>

    <!-- Filter indicator -->
    <div class="admin-alert info" id="filter-indicator" style="display:none; margin: 0.4rem 1rem;">
        <i class="fas fa-filter"></i> <span id="filter-message">Filtro attivo</span>
        <button class="sys-btn small" onclick="resetFilters()" style="margin-left:auto"><i class="fas fa-times"></i> Reset</button>
    </div>

    <!-- No results message -->
    <div class="no-filter-results" id="noFilterResults">
        <i class="fas fa-search"></i>
        <p><strong>Nessun risultato trovato</strong></p>
        <p>Prova a modificare i criteri di ricerca</p>
    </div>

    <!-- Reviews List - Stile card identico a breweries -->
    <div class="review-list">
        {% if reviews and reviews.length > 0 %}
            {% for review in reviews %}
                {% set firstRating = review.ratings[0] if review.ratings and review.ratings.length > 0 else null %}
                {% set beerName = firstRating.beer.beerName if firstRating and firstRating.beer else (firstRating.bottleLabel if firstRating else 'Birra sconosciuta') %}
                {% set breweryName = firstRating.brewery.breweryName if firstRating and firstRating.brewery else 'Birrificio sconosciuto' %}
                {% set rating = firstRating.rating if firstRating else 0 %}
                {% set userName = review.user.customerDetails.customerName + ' ' + review.user.customerDetails.customerSurname if review.user and review.user.customerDetails and review.user.customerDetails.customerName else (review.user.username if review.user else 'Utente anonimo') %}
                {% set userEmail = review.user.email if review.user else '' %}
                {% set isBanned = review.user.isBanned if review.user else false %}
                {% set userId = review.user._id if review.user else null %}
                
                {% set isHiddenReview = review.moderation and review.moderation.isHidden %}
                <div class="review-item {{ 'is-hidden' if isHiddenReview }}" 
                     data-review-id="{{ review._id }}"
                     data-beer-name="{{ beerName }}"
                     data-brewery-name="{{ breweryName }}"
                     data-user-name="{{ userName }}"
                     data-user-email="{{ userEmail }}"
                     data-rating="{{ rating }}"
                     data-status="{{ review.status or 'pending' }}"
                     data-processing-status="{{ review.processingStatus or 'completed' }}"
                     data-is-hidden="{{ 'true' if isHiddenReview else 'false' }}"
                     data-date="{{ review.date | date('YYYY-MM-DD') if review.date else '' }}"
                     {% if review.processingStatus == 'pending_validation' or review.processingStatus == 'processing' %}style="border-left: 3px solid #06b6d4;"{% endif %}>
                    
                    <!-- Thumbnail con immagine della recensione -->
                    <div class="review-thumb">
                        {% if review.resolvedImageUrl %}
                            <img src="{{ review.resolvedImageUrl }}" alt="{{ beerName }}" loading="lazy" onerror="this.onerror=null; this.outerHTML='<div class=\'no-photo\'><i class=\'fas fa-beer\'></i></div>';">
                        {% else %}
                            <div class="no-photo"><i class="fas fa-beer"></i></div>
                        {% endif %}
                    </div>
                    
                    <!-- Content -->
                    <div class="review-info">
                        <span class="review-beer-name">{{ beerName }}</span>
                        <span class="review-brewery-name">{{ breweryName }}</span>
                        <div class="review-meta">
                            <span class="review-meta-item user {% if isBanned %}user-banned{% endif %}">
                                {% if isBanned %}<i class="fas fa-ban"></i>{% else %}<i class="fas fa-user"></i>{% endif %}
                                {{ userName }}
                            </span>
                            <span class="review-meta-item date">
                                <i class="fas fa-calendar"></i>
                                {{ review.date | date('DD/MM/YYYY') if review.date else 'N/D' }}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Rating -->
                    <div class="review-rating">
                        {% if rating > 0 %}
                        <div class="stars">
                            {% for i in range(1, 6) %}
                                <i class="fas fa-star {% if i > rating %}empty{% endif %}"></i>
                            {% endfor %}
                        </div>
                        {% else %}
                        <span class="rating-value-text">N/V</span>
                        {% endif %}
                    </div>
                    
                    <!-- Status Badges -->
                    <div class="review-badges">
                        <!-- Hidden badge -->
                        {% if isHiddenReview %}
                        <span class="hidden-badge">
                            <i class="fas fa-eye-slash"></i> Nascosta
                        </span>
                        {% endif %}
                        
                        <!-- Status Moderazione -->
                        <span class="review-status status-{{ review.status or 'pending' }}" title="Stato moderazione">
                            {% if review.status == 'validated' %}
                                <i class="fas fa-check"></i> Validata
                            {% elif review.status == 'completed' %}
                                <i class="fas fa-check-double"></i> OK
                            {% elif review.status == 'hidden' %}
                                <i class="fas fa-eye-slash"></i> Nascosta
                            {% elif review.status == 'flagged' %}
                                <i class="fas fa-flag"></i> Segnalata
                            {% elif review.status == 'needs_admin' %}
                                <i class="fas fa-exclamation-triangle"></i> Verifica
                            {% else %}
                                <i class="fas fa-clock"></i> Attesa
                            {% endif %}
                        </span>
                        <!-- Processing Status AI -->
                        {% set isProcessing = review.processingStatus == 'pending_validation' or review.processingStatus == 'processing' %}
                        <span class="processing-status processing-{{ review.processingStatus or 'completed' }} {{ 'is-processing' if isProcessing }}" title="Stato elaborazione">
                            {% if isProcessing %}
                                <span class="ai-spinner"></span>
                            {% else %}
                                <i class="fas fa-robot" style="font-size: 0.55rem;"></i>
                            {% endif %}
                            {% if review.processingStatus == 'pending_validation' %}
                                Coda
                            {% elif review.processingStatus == 'processing' %}
                                AI...
                            {% elif review.processingStatus == 'completed' %}
                                AI OK
                            {% elif review.processingStatus == 'failed' %}
                                Fallito
                            {% elif review.processingStatus == 'needs_admin_review' %}
                                Verifica
                            {% else %}
                                AI OK
                            {% endif %}
                        </span>
                    </div>
                    
                    <!-- Admin Actions (Icon Buttons) -->
                    <div class="review-admin-actions">
                        <button class="btn-icon view" onclick="showReviewDetail('{{ review._id }}')" title="Dettagli">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon edit" onclick="showEditReviewModal('{{ review._id }}')" title="Modifica">
                            <i class="fas fa-edit"></i>
                        </button>
                        {% if review.status != 'validated' and review.status != 'completed' %}
                        <button class="btn-icon validate" onclick="updateReviewStatus('{{ review._id }}', 'validated')" title="Valida">
                            <i class="fas fa-check"></i>
                        </button>
                        {% endif %}
                        <button class="btn-icon hide" onclick="toggleReviewVisibility('{{ review._id }}')" title="{{ 'Mostra' if review.moderation and review.moderation.isHidden else 'Nascondi' }}">
                            <i class="fas {{ 'fa-eye' if review.moderation and review.moderation.isHidden else 'fa-eye-slash' }}"></i>
                        </button>
                        {% if userId and not isBanned %}
                        <button class="btn-icon ban" onclick="showBanModal('{{ userId }}', '{{ userName | replace("'", "\\'") }}')" title="Banna utente">
                            <i class="fas fa-ban"></i>
                        </button>
                        {% elif userId and isBanned %}
                        <button class="btn-icon unban" onclick="showUnbanModal('{{ userId }}', '{{ userName | replace("'", "\\'") }}')" title="Rimuovi ban">
                            <i class="fas fa-user-check"></i>
                        </button>
                        {% endif %}
                        <button class="btn-icon delete" onclick="showDeleteModal('{{ review._id }}')" title="Elimina">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h3>Nessuna recensione trovata</h3>
                <p>Non ci sono recensioni che corrispondono ai filtri selezionati.</p>
            </div>
        {% endif %}
    </div>

    <!-- Pagination -->
    {% if pagination and pagination.totalPages > 1 %}
    <div class="pagination">
        {% if pagination.currentPage > 1 %}
            <a href="?page={{ pagination.currentPage - 1 }}{{ '&status=' + filters.status if filters.status }}{{ '&sort=' + filters.sort if filters.sort }}{{ '&search=' + filters.search if filters.search }}">
                <i class="fas fa-chevron-left"></i>
            </a>
        {% else %}
            <span class="disabled"><i class="fas fa-chevron-left"></i></span>
        {% endif %}
        
        {% for p in range(1, pagination.totalPages + 1) %}
            {% if p == pagination.currentPage %}
                <span class="current">{{ p }}</span>
            {% elif p == 1 or p == pagination.totalPages or (p >= pagination.currentPage - 2 and p <= pagination.currentPage + 2) %}
                <a href="?page={{ p }}{{ '&status=' + filters.status if filters.status }}{{ '&sort=' + filters.sort if filters.sort }}{{ '&search=' + filters.search if filters.search }}">{{ p }}</a>
            {% elif p == pagination.currentPage - 3 or p == pagination.currentPage + 3 %}
                <span>...</span>
            {% endif %}
        {% endfor %}
        
        {% if pagination.currentPage < pagination.totalPages %}
            <a href="?page={{ pagination.currentPage + 1 }}{{ '&status=' + filters.status if filters.status }}{{ '&sort=' + filters.sort if filters.sort }}{{ '&search=' + filters.search if filters.search }}">
                <i class="fas fa-chevron-right"></i>
            </a>
        {% else %}
            <span class="disabled"><i class="fas fa-chevron-right"></i></span>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Review Detail Modal -->
<div class="modal-overlay" id="detailModal">
    <div class="modal-content" style="max-width: 580px;">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-search-plus"></i> Dettaglio Recensione</h3>
            <button class="modal-close" onclick="closeModal('detailModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="detailModalBody">
            <!-- Populated by JavaScript -->
        </div>
    </div>
</div>

<!-- Ban User Modal -->
<div class="modal-overlay" id="banModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-ban" style="color: #c2185b;"></i> Banna Utente</h3>
            <button class="modal-close" onclick="closeModal('banModal')">&times;</button>
        </div>
        <div class="modal-body">
            <p>Sei sicuro di voler bannare l'utente <strong id="banUserName"></strong>?</p>
            <p style="color: #888; font-size: 0.875rem; margin-top: 0.5rem;">
                L'utente non potrà più accedere alla piattaforma.
            </p>
            <input type="hidden" id="banUserId">
        </div>
        <div class="modal-footer">
            <button class="btn-modal cancel" onclick="closeModal('banModal')">Annulla</button>
            <button class="btn-modal confirm" onclick="confirmBanUser()">
                <i class="fas fa-ban"></i> Banna
            </button>
        </div>
    </div>
</div>

<!-- Unban User Modal -->
<div class="modal-overlay" id="unbanModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-user-check" style="color: #2e7d32;"></i> Rimuovi Ban Utente</h3>
            <button class="modal-close" onclick="closeModal('unbanModal')">&times;</button>
        </div>
        <div class="modal-body">
            <p>Sei sicuro di voler rimuovere il ban all'utente <strong id="unbanUserName"></strong>?</p>
            <p style="color: #888; font-size: 0.875rem; margin-top: 0.5rem;">
                L'utente potrà nuovamente accedere alla piattaforma.
            </p>
            <input type="hidden" id="unbanUserId">
        </div>
        <div class="modal-footer">
            <button class="btn-modal cancel" onclick="closeModal('unbanModal')">Annulla</button>
            <button class="btn-modal confirm" style="background: linear-gradient(135deg, #43a047, #2e7d32);" onclick="confirmUnbanUser()">
                <i class="fas fa-user-check"></i> Rimuovi Ban
            </button>
        </div>
    </div>
</div>

<!-- Delete Review Modal -->
<div class="modal-overlay" id="deleteModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-trash" style="color: #d32f2f;"></i> Elimina Recensione</h3>
            <button class="modal-close" onclick="closeModal('deleteModal')">&times;</button>
        </div>
        <div class="modal-body">
            <p>Sei sicuro di voler eliminare questa recensione?</p>
            <p style="color: #888; font-size: 0.875rem; margin-top: 0.5rem;">
                Questa azione è irreversibile.
            </p>
            <input type="hidden" id="deleteReviewId">
        </div>
        <div class="modal-footer">
            <button class="btn-modal cancel" onclick="closeModal('deleteModal')">Annulla</button>
            <button class="btn-modal confirm" onclick="confirmDeleteReview()">
                <i class="fas fa-trash"></i> Elimina
            </button>
        </div>
    </div>
</div>

<!-- Edit Review Modal -->
<div class="modal-overlay" id="editReviewModal">
    <div class="modal-content" style="max-width: 620px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #3f51b5 0%, #1a237e 100%);">
            <h3 class="modal-title"><i class="fas fa-edit"></i> Modifica Recensione</h3>
            <button class="modal-close" onclick="closeModal('editReviewModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="editReviewModalBody">
            <!-- Popolato via JavaScript -->
            <div class="text-center p-4">
                <div class="filter-spinner" style="margin: 0 auto;"></div>
                <p style="margin-top: 0.5rem; color: #6b7280; font-size: 0.875rem;">Caricamento dati...</p>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay per cambio filtri -->
<div id="filterLoadingOverlay" class="filter-loading-overlay">
    <div class="filter-spinner"></div>
    <span class="filter-loading-text">Caricamento...</span>
</div>
{% endblock %}

{% block scripts %}
<script>
// ===== STAT BOX FILTRI (stile identico a breweries/beers) =====
document.addEventListener('DOMContentLoaded', function() {
    const currentFilter = '{{ filters.filter or "" }}';
    const currentStatus = '{{ filters.status or "" }}';
    const currentProcessing = '{{ filters.processingStatus or "" }}';
    
    // Attiva la stat-box del filtro moderazione corrente
    const activeModFilter = currentStatus || currentFilter || 'all';
    document.querySelectorAll('.review-filter-card').forEach(card => {
        card.classList.remove('active');
        if (card.dataset.filter === activeModFilter) {
            card.classList.add('active');
        }
    });
    
    // Attiva la stat-box del filtro AI processing corrente
    if (currentProcessing) {
        const processingValue = currentProcessing === 'completed' ? 'ai_completed' : currentProcessing;
        document.querySelectorAll('.ai-filter-card').forEach(card => {
            card.classList.remove('active');
            if (card.dataset.processingFilter === processingValue) {
                card.classList.add('active');
            }
        });
    }
    
    // Mostra indicatore se filtro attivo 
    if (activeModFilter !== 'all' || currentProcessing) {
        const indicator = document.getElementById('filter-indicator');
        const message = document.getElementById('filter-message');
        if (indicator && message) {
            indicator.style.display = 'flex';
            let filterText = [];
            if (activeModFilter !== 'all') filterText.push('Moderazione: ' + activeModFilter);
            if (currentProcessing) filterText.push('AI: ' + currentProcessing);
            message.textContent = filterText.join(' | ');
        }
    }
});

// Click handler per filtri moderazione (stat-box)
document.querySelectorAll('.review-filter-card').forEach(card => {
    card.addEventListener('click', function() {
        const filter = this.dataset.filter;
        filterByStatus(filter);
    });
});

// Click handler per filtri AI processing (stat-box)
document.querySelectorAll('.ai-filter-card').forEach(card => {
    card.addEventListener('click', function() {
        const filter = this.dataset.processingFilter;
        filterByProcessing(filter);
    });
});

// Store reviews data for detail modal
const reviewsData = {};
{% for review in reviews %}
{% set firstRating = review.ratings[0] if review.ratings and review.ratings.length > 0 else null %}
{% set beerNameJs = (firstRating.beer.beerName if firstRating and firstRating.beer else (firstRating.bottleLabel if firstRating else 'Birra sconosciuta')) | replace("'", "\\'") | replace("\n", " ") | replace("\r", " ") %}
{% set breweryNameJs = (firstRating.brewery.breweryName if firstRating and firstRating.brewery else 'Birrificio sconosciuto') | replace("'", "\\'") | replace("\n", " ") | replace("\r", " ") %}
{% set beerTypeJs = (firstRating.beer.beerType if firstRating and firstRating.beer else 'N/D') | replace("'", "\\'") | replace("\n", " ") | replace("\r", " ") %}
{% set alcoholJs = (firstRating.beer.alcoholContent if firstRating and firstRating.beer else 'N/D') | replace("'", "\\'") | replace("\n", " ") | replace("\r", " ") %}
{% set ratingJs = firstRating.rating if firstRating and firstRating.rating else 0 %}
{% set notesJs = (firstRating.notes if firstRating and firstRating.notes else '') | replace("'", "\\'") | replace("\n", " ") | replace("\r", " ") %}
{% set userNameJs = (review.user.customerDetails.customerName ~ ' ' ~ review.user.customerDetails.customerSurname if review.user and review.user.customerDetails and review.user.customerDetails.customerName else (review.user.username if review.user else 'Utente anonimo')) | replace("'", "\\'") | replace("\n", " ") | replace("\r", " ") %}
{% set appearanceRating = firstRating.detailedRatings.appearance.rating if firstRating and firstRating.detailedRatings and firstRating.detailedRatings.appearance and firstRating.detailedRatings.appearance.rating else 0 %}
{% set aromaRating = firstRating.detailedRatings.aroma.rating if firstRating and firstRating.detailedRatings and firstRating.detailedRatings.aroma and firstRating.detailedRatings.aroma.rating else 0 %}
{% set tasteRating = firstRating.detailedRatings.taste.rating if firstRating and firstRating.detailedRatings and firstRating.detailedRatings.taste and firstRating.detailedRatings.taste.rating else 0 %}
{% set mouthfeelRating = firstRating.detailedRatings.mouthfeel.rating if firstRating and firstRating.detailedRatings and firstRating.detailedRatings.mouthfeel and firstRating.detailedRatings.mouthfeel.rating else 0 %}
reviewsData['{{ review._id }}'] = {
    id: '{{ review._id }}',
    beerName: '{{ beerNameJs }}',
    breweryName: '{{ breweryNameJs }}',
    beerType: '{{ beerTypeJs }}',
    alcoholContent: '{{ alcoholJs }}',
    rating: {{ ratingJs if ratingJs else 0 }},
    notes: '{{ notesJs }}',
    userName: '{{ userNameJs }}',
    userEmail: '{{ review.user.email if review.user and review.user.email else "" }}',
    date: '{{ review.date | date("DD/MM/YYYY HH:mm") if review.date else "N/D" }}',
    status: '{{ review.status or "pending" }}',
    beerId: '{{ firstRating.beer._id if firstRating and firstRating.beer and firstRating.beer._id else "" }}',
    breweryId: '{{ firstRating.brewery._id if firstRating and firstRating.brewery and firstRating.brewery._id else "" }}',
    detailedRatings: {
        appearance: {{ appearanceRating if appearanceRating else 0 }},
        aroma: {{ aromaRating if aromaRating else 0 }},
        taste: {{ tasteRating if tasteRating else 0 }},
        mouthfeel: {{ mouthfeelRating if mouthfeelRating else 0 }}
    }
};
{% endfor %}

function showLoadingOverlay() {
    const overlay = document.getElementById('filterLoadingOverlay');
    if (overlay) {
        overlay.classList.add('active');
    }
}

function filterByStatus(status) {
    showLoadingOverlay();
    const url = new URL(window.location.href);
    if (status === 'all') {
        url.searchParams.delete('status');
        url.searchParams.delete('filter');
    } else {
        url.searchParams.set('status', status);
    }
    url.searchParams.delete('page');
    url.searchParams.delete('processingStatus');
    window.location.href = url.toString();
}

function filterByProcessing(processingStatus) {
    showLoadingOverlay();
    const url = new URL(window.location.href);
    if (processingStatus === 'all' || processingStatus === 'ai_completed') {
        if (processingStatus === 'ai_completed') {
            url.searchParams.set('processingStatus', 'completed');
        } else {
            url.searchParams.delete('processingStatus');
        }
    } else {
        url.searchParams.set('processingStatus', processingStatus);
    }
    url.searchParams.delete('page');
    url.searchParams.delete('status');
    window.location.href = url.toString();
}

function resetFilters() {
    showLoadingOverlay();
    window.location.href = '/administrator/reviews';
}

// ===== QUICK SEARCH (stile identico a breweries) =====
function handleQuickSearch(input) {
    const value = input.value.toLowerCase().trim();
    const searchBox = document.getElementById('reviewSearchBox');
    
    // Toggle classe has-value per mostrare/nascondere pulsante clear
    if (value.length > 0) {
        searchBox.classList.add('has-value');
    } else {
        searchBox.classList.remove('has-value');
    }
    
    // Filtra le card client-side
    const items = document.querySelectorAll('.review-item');
    let visibleCount = 0;
    
    items.forEach(item => {
        if (value.length < 2) {
            item.style.display = '';
            visibleCount++;
            return;
        }
        
        const beerName = (item.dataset.beerName || '').toLowerCase();
        const breweryName = (item.dataset.breweryName || '').toLowerCase();
        const userName = (item.dataset.userName || '').toLowerCase();
        const userEmail = (item.dataset.userEmail || '').toLowerCase();
        
        const match = beerName.includes(value) || breweryName.includes(value) || 
                      userName.includes(value) || userEmail.includes(value);
        
        item.style.display = match ? '' : 'none';
        if (match) visibleCount++;
    });
    
    // Mostra/nascondi messaggio "nessun risultato"
    const noResults = document.getElementById('noFilterResults');
    if (value.length >= 2 && visibleCount === 0) {
        noResults.classList.add('visible');
    } else {
        noResults.classList.remove('visible');
    }
}

function clearQuickSearch() {
    const input = document.getElementById('reviewSearchInput');
    input.value = '';
    document.getElementById('reviewSearchBox').classList.remove('has-value');
    handleQuickSearch(input);
}

function showReviewDetail(reviewId) {
    const review = reviewsData[reviewId];
    if (!review) return;
    
    // Genera stelle o "Non valutata"
    const starsHtml = review.rating > 0 
        ? Array.from({length: 5}, (_, i) => 
            `<i class="fas fa-star ${i >= review.rating ? 'empty' : ''}"></i>`
          ).join('')
        : '<span class="not-rated-label">Non valutata</span>';
    
    // Genera rating dettagliati con sole stelle e note
    const renderDetailedRating = (value, label, icon, isOverall = false, noteText = '') => {
        const itemClass = isOverall ? 'detailed-rating-item overall' : 'detailed-rating-item';
        const noteHtml = noteText ? `<div style="font-size: 0.55rem; color: #666; margin-top: 3px; line-height: 1.2; max-height: 2.4em; overflow: hidden; text-overflow: ellipsis;">${noteText}</div>` : '';
        if (!value || value === 0) {
            return `<div class="${itemClass}">
                <div class="detailed-rating-label">${icon} ${label}</div>
                <div style="color: #bbb; font-size: 0.6rem;">—</div>
                ${noteHtml}
            </div>`;
        }
        const starSize = isOverall ? '0.7rem' : '0.55rem';
        const miniStars = Array.from({length: 5}, (_, i) => 
            `<i class="fas fa-star" style="font-size: ${starSize}; color: ${i < value ? '#ffc107' : '#e0e0e0'};"></i>`
        ).join('');
        return `<div class="${itemClass}">
            <div class="detailed-rating-label">${icon} ${label}</div>
            <div style="margin-top: 2px;">${miniStars}</div>
            ${noteHtml}
        </div>`;
    };
    
    document.getElementById('detailModalBody').innerHTML = `
        <div class="detail-section">
            <h4><i class="fas fa-beer"></i> Birra</h4>
            <div class="detail-row">
                <span class="detail-label">Nome</span>
                <span class="detail-value">${review.beerName}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Birrificio</span>
                <span class="detail-value">${review.breweryName}</span>
            </div>
            ${review.beerType ? `<div class="detail-row">
                <span class="detail-label">Stile</span>
                <span class="detail-value">${review.beerType}</span>
            </div>` : ''}
            ${review.alcoholContent ? `<div class="detail-row">
                <span class="detail-label">Gradazione</span>
                <span class="detail-value">${review.alcoholContent}%</span>
            </div>` : ''}
        </div>
        
        <div class="detail-section">
            <h4><i class="fas fa-star"></i> Valutazione</h4>
            ${review.rating > 0 ? `
            <div class="detailed-ratings-grid">
                ${renderDetailedRating(review.rating, 'Complessiva', '⭐', true, review.notes)}
                ${renderDetailedRating(review.detailedRatings?.appearance?.rating || review.detailedRatings?.appearance, 'Aspetto', '👁️', false, review.detailedRatings?.appearance?.notes)}
                ${renderDetailedRating(review.detailedRatings?.aroma?.rating || review.detailedRatings?.aroma, 'Aroma', '👃', false, review.detailedRatings?.aroma?.notes)}
                ${renderDetailedRating(review.detailedRatings?.taste?.rating || review.detailedRatings?.taste, 'Gusto', '👅', false, review.detailedRatings?.taste?.notes)}
                ${renderDetailedRating(review.detailedRatings?.mouthfeel?.rating || review.detailedRatings?.mouthfeel, 'Corpo', '💧', false, review.detailedRatings?.mouthfeel?.notes)}
            </div>` : `<div style="text-align: center; padding: 0.3rem 0; color: #999; font-style: italic; font-size: 0.8rem;">Non valutata</div>`}
        </div>
        
        <div class="detail-section">
            <h4><i class="fas fa-user"></i> Utente</h4>
            <div class="detail-row">
                <span class="detail-label">Nome</span>
                <span class="detail-value">${review.userName}</span>
            </div>
            ${review.userEmail ? `<div class="detail-row">
                <span class="detail-label">Email</span>
                <span class="detail-value">${review.userEmail}</span>
            </div>` : ''}
            <div class="detail-row">
                <span class="detail-label">Data</span>
                <span class="detail-value">${review.date}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Stato moderazione</span>
                <span class="detail-value"><span class="review-status status-${review.status}">${getStatusLabel(review.status)}</span></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Stato elaborazione</span>
                <span class="detail-value"><span class="processing-status processing-${review.processingStatus || 'completed'}">${getProcessingLabel(review.processingStatus)}</span></span>
            </div>
        </div>
    `;
    
    document.getElementById('detailModal').classList.add('active');
}

function getStatusLabel(status) {
    const labels = {
        pending: 'In attesa',
        validated: 'Validata',
        completed: 'Completata',
        hidden: 'Nascosta',
        flagged: 'Segnalata'
    };
    return labels[status] || status;
}

function getProcessingLabel(processingStatus) {
    const labels = {
        pending_validation: 'In elaborazione AI',
        processing: 'Elaborazione in corso',
        completed: 'AI completato',
        failed: 'Elaborazione fallita',
        ai_completed: 'AI completato'
    };
    return labels[processingStatus] || processingStatus || 'Completato';
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function showBanModal(userId, userName) {
    document.getElementById('banUserId').value = userId;
    document.getElementById('banUserName').textContent = userName;
    document.getElementById('banModal').classList.add('active');
}

function showUnbanModal(userId, userName) {
    document.getElementById('unbanUserId').value = userId;
    document.getElementById('unbanUserName').textContent = userName;
    document.getElementById('unbanModal').classList.add('active');
}

function showDeleteModal(reviewId) {
    document.getElementById('deleteReviewId').value = reviewId;
    document.getElementById('deleteModal').classList.add('active');
}

async function updateReviewStatus(reviewId, status) {
    try {
        const response = await fetch(`/administrator/api/reviews/${reviewId}/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Errore durante l\'aggiornamento');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Errore durante l\'aggiornamento dello stato');
    }
}

async function toggleReviewVisibility(reviewId) {
    try {
        const response = await fetch(`/administrator/api/reviews/${reviewId}/visibility`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
            const data = await response.json();
            const isNowHidden = data.message.includes('nascosta');
            
            // Aggiorna la UI della card senza ricaricare
            const card = document.querySelector(`.review-item[data-review-id="${reviewId}"]`);
            if (card) {
                // Toggle classe is-hidden
                card.classList.toggle('is-hidden', isNowHidden);
                card.dataset.isHidden = isNowHidden ? 'true' : 'false';
                
                // Aggiorna/rimuovi badge "Nascosta"
                let badge = card.querySelector('.hidden-badge');
                if (isNowHidden && !badge) {
                    badge = document.createElement('div');
                    badge.className = 'hidden-badge';
                    badge.innerHTML = '<i class="fas fa-eye-slash"></i> Nascosta';
                    card.insertBefore(badge, card.firstChild);
                } else if (!isNowHidden && badge) {
                    badge.remove();
                }
                
                // Aggiorna icona e title del pulsante
                const btn = card.querySelector('.btn-icon.hide');
                if (btn) {
                    const icon = btn.querySelector('i');
                    if (icon) {
                        icon.className = isNowHidden ? 'fas fa-eye' : 'fas fa-eye-slash';
                    }
                    btn.title = isNowHidden ? 'Mostra' : 'Nascondi';
                }
            }
        } else {
            const data = await response.json();
            alert(data.error || 'Errore durante il cambio visibilità');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Errore durante il cambio visibilità');
    }
}

async function confirmBanUser() {
    const userId = document.getElementById('banUserId').value;
    
    try {
        const response = await fetch(`/administrator/api/users/${userId}/ban`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
            closeModal('banModal');
            window.location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Errore durante il ban dell\'utente');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Errore durante il ban dell\'utente');
    }
}

async function confirmUnbanUser() {
    const userId = document.getElementById('unbanUserId').value;
    
    try {
        const response = await fetch(`/administrator/api/users/${userId}/unban`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
            closeModal('unbanModal');
            window.location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Errore durante la rimozione del ban');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Errore durante la rimozione del ban');
    }
}

async function confirmDeleteReview() {
    const reviewId = document.getElementById('deleteReviewId').value;
    
    try {
        const response = await fetch(`/administrator/api/reviews/${reviewId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
            closeModal('deleteModal');
            window.location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Errore durante l\'eliminazione');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Errore durante l\'eliminazione della recensione');
    }
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.remove('active');
        }
    });
});

// Close modals on ESC key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(modal => {
            modal.classList.remove('active');
        });
    }
});

// Highlight active filter card from URL
const currentStatusUrl = new URLSearchParams(window.location.search).get('status');
document.querySelectorAll('.review-filter-card').forEach(card => {
    if (card.dataset.filter === (currentStatusUrl || 'all')) {
        card.classList.add('active');
    }
});

// ============================================
// MODAL MODIFICA RECENSIONE
// ============================================

// Cache locale birre e birrifici (caricata una volta sola)
let cachedBeers = null;
let cachedBreweries = null;
let editCurrentReviewId = null;

/**
 * Carica l'elenco di birre e birrifici dall'API (con cache)
 */
async function loadBeersAndBreweries() {
    if (cachedBeers && cachedBreweries) {
        return { beers: cachedBeers, breweries: cachedBreweries };
    }
    const response = await fetch('/administrator/api/reviews/beers-breweries');
    if (!response.ok) throw new Error('Errore nel caricamento dati');
    const data = await response.json();
    if (!data.success) throw new Error(data.error || 'Errore sconosciuto');
    cachedBeers = data.beers;
    cachedBreweries = data.breweries;
    return { beers: cachedBeers, breweries: cachedBreweries };
}

/**
 * Apre il modal di modifica per una recensione
 */
async function showEditReviewModal(reviewId) {
    const review = reviewsData[reviewId];
    if (!review) return;

    editCurrentReviewId = reviewId;
    const modal = document.getElementById('editReviewModal');
    const body = document.getElementById('editReviewModalBody');

    // Mostra loading
    body.innerHTML = `
        <div class="text-center p-4">
            <div class="filter-spinner" style="margin: 0 auto;"></div>
            <p style="margin-top: 0.5rem; color: #6b7280; font-size: 0.875rem;">Caricamento dati...</p>
        </div>
    `;
    modal.classList.add('active');

    try {
        // Carica elenchi birre e birrifici
        const { beers, breweries } = await loadBeersAndBreweries();

        // Genera stelle per il rating (sola lettura)
        const ratingStarsHtml = review.rating > 0
            ? Array.from({length: 5}, (_, i) =>
                `<i class="fas fa-star ${i >= review.rating ? 'empty' : ''}"></i>`
              ).join('')
            : '<span style="color: #999; font-style: italic; font-size: 0.85rem;">Non valutata</span>';

        // Birre filtrate per birrificio corrente
        const currentBreweryId = review.breweryId;

        body.innerHTML = `
            <!-- Sezione Rating (sola lettura) -->
            <div class="edit-form-group">
                <label><i class="fas fa-star"></i> Valutazione Complessiva</label>
                <div class="edit-rating-display">
                    <div class="stars">${ratingStarsHtml}</div>
                    ${review.rating > 0 ? `<span style="font-weight: 600; color: #f59e0b;">${review.rating}/5</span>` : ''}
                    <span class="edit-rating-lock"><i class="fas fa-lock"></i> Non modificabile</span>
                </div>
            </div>

            <!-- Sezione Birrificio -->
            <div class="edit-section-divider brewery-section"><i class="fas fa-industry"></i> Birrificio</div>
            <div class="edit-form-group">
                <label><i class="fas fa-industry"></i> Birrificio</label>
                <div class="searchable-select" id="brewerySearchable">
                    <input type="text" class="searchable-select-input" id="editBreweryInput" placeholder="Cerca birrificio..." autocomplete="off">
                    <button class="searchable-select-clear" onclick="clearSearchableSelect('brewery')" title="Rimuovi selezione"><i class="fas fa-times"></i></button>
                    <span class="searchable-select-chevron"><i class="fas fa-chevron-down"></i></span>
                    <input type="hidden" id="editBreweryValue">
                    <div class="searchable-select-dropdown" id="breweryDropdown"></div>
                </div>
            </div>

            <!-- Sezione Birra -->
            <div class="edit-section-divider beer-section"><i class="fas fa-beer"></i> Birra</div>
            <div class="edit-form-group">
                <label><i class="fas fa-beer"></i> Birra</label>
                <div class="searchable-select" id="beerSearchable">
                    <input type="text" class="searchable-select-input" id="editBeerInput" placeholder="Cerca birra..." autocomplete="off">
                    <button class="searchable-select-clear" onclick="clearSearchableSelect('beer')" title="Rimuovi selezione"><i class="fas fa-times"></i></button>
                    <span class="searchable-select-chevron"><i class="fas fa-chevron-down"></i></span>
                    <input type="hidden" id="editBeerValue">
                    <div class="searchable-select-dropdown" id="beerDropdown"></div>
                </div>
                <p style="font-size: 0.65rem; color: #9ca3af; margin-top: 4px;">
                    <i class="fas fa-info-circle"></i> Seleziona il birrificio per filtrare le birre, oppure cerca tra tutte le birre registrate.
                </p>
            </div>

            <div class="edit-form-row">
                <div class="edit-form-group">
                    <label><i class="fas fa-tag"></i> Tipo / Stile</label>
                    <input type="text" id="editBeerType" class="edit-form-input" value="${escapeAttr(review.beerType !== 'N/D' ? review.beerType : '')}" placeholder="Es. IPA, Lager, Stout...">
                </div>
                <div class="edit-form-group">
                    <label><i class="fas fa-percentage"></i> Gradazione (ABV)</label>
                    <input type="text" id="editAlcoholContent" class="edit-form-input" value="${escapeAttr(review.alcoholContent !== 'N/D' ? review.alcoholContent : '')}" placeholder="Es. 5.5">
                </div>
            </div>

            <!-- Sezione Note -->
            <div class="edit-section-divider notes-section"><i class="fas fa-comment-alt"></i> Note della Recensione</div>
            <div class="edit-form-group">
                <label><i class="fas fa-pencil-alt"></i> Note / Impressioni</label>
                <textarea id="editNotes" class="edit-form-textarea" placeholder="Note e impressioni sulla birra...">${escapeHtmlContent(review.notes)}</textarea>
            </div>

            <!-- Footer con azioni -->
            <div class="edit-modal-footer">
                <button class="btn-edit-cancel" onclick="closeModal('editReviewModal')">Annulla</button>
                <button class="btn-edit-save" id="editSaveBtn" onclick="submitEditReview()">
                    <i class="fas fa-save"></i> Salva Modifiche
                </button>
            </div>
        `;

        // Inizializza i searchable select per birrificio e birra
        initSearchableSelects(review);

    } catch (error) {
        console.error('Errore apertura modal modifica:', error);
        body.innerHTML = `
            <div style="text-align: center; padding: 1rem; color: #dc2626;">
                <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                <p>Errore nel caricamento: ${error.message}</p>
            </div>
            <div class="edit-modal-footer">
                <button class="btn-edit-cancel" onclick="closeModal('editReviewModal')">Chiudi</button>
            </div>
        `;
    }
}

// ===== SEARCHABLE SELECT: Birrificio e Birra =====

// Stato corrente del birrificio selezionato (per filtrare le birre)
let selectedEditBreweryId = '';
let highlightedBreweryIdx = -1;
let highlightedBeerIdx = -1;

/**
 * Inizializza i due searchable select dopo il rendering del modal
 */
function initSearchableSelects(review) {
    const breweryInput = document.getElementById('editBreweryInput');
    const beerInput = document.getElementById('editBeerInput');
    const breweryHidden = document.getElementById('editBreweryValue');
    const beerHidden = document.getElementById('editBeerValue');
    const breweryWrapper = document.getElementById('brewerySearchable');
    const beerWrapper = document.getElementById('beerSearchable');

    // Pre-popola con i valori correnti della recensione
    if (review.breweryId && cachedBreweries) {
        const br = cachedBreweries.find(b => b._id === review.breweryId);
        if (br) {
            breweryInput.value = br.name;
            breweryHidden.value = br._id;
            selectedEditBreweryId = br._id;
            breweryWrapper.classList.add('has-value');
        }
    }
    if (review.beerId && cachedBeers) {
        const be = cachedBeers.find(b => b._id === review.beerId);
        if (be) {
            beerInput.value = be.name;
            beerHidden.value = be._id;
            beerWrapper.classList.add('has-value');
        }
    }

    // === BIRRIFICIO: eventi ===
    breweryInput.addEventListener('input', () => {
        highlightedBreweryIdx = -1;
        renderBreweryDropdown(breweryInput.value.trim());
        openDropdown('brewery');
        // Reset selezione birrificio se si modifica il testo
        breweryHidden.value = '';
        selectedEditBreweryId = '';
        breweryWrapper.classList.remove('has-value');
    });
    breweryInput.addEventListener('focus', () => {
        renderBreweryDropdown(breweryInput.value.trim());
        openDropdown('brewery');
    });
    breweryInput.addEventListener('keydown', (e) => handleDropdownKeyboard(e, 'brewery'));

    // === BIRRA: eventi ===
    beerInput.addEventListener('input', () => {
        highlightedBeerIdx = -1;
        renderBeerDropdown(beerInput.value.trim());
        openDropdown('beer');
        beerHidden.value = '';
        beerWrapper.classList.remove('has-value');
    });
    beerInput.addEventListener('focus', () => {
        renderBeerDropdown(beerInput.value.trim());
        openDropdown('beer');
    });
    beerInput.addEventListener('keydown', (e) => handleDropdownKeyboard(e, 'beer'));

    // Chiudi dropdown al click fuori
    document.addEventListener('click', (e) => {
        if (!breweryWrapper.contains(e.target)) closeDropdown('brewery');
        if (!beerWrapper.contains(e.target)) closeDropdown('beer');
    });
}

/**
 * Renderizza il dropdown dei birrifici filtrati per testo
 */
function renderBreweryDropdown(query) {
    const dropdown = document.getElementById('breweryDropdown');
    if (!dropdown || !cachedBreweries) return;

    const q = query.toLowerCase();
    const filtered = q.length > 0
        ? cachedBreweries.filter(b => b.name.toLowerCase().includes(q))
        : cachedBreweries;

    if (filtered.length === 0) {
        dropdown.innerHTML = '<div class="searchable-select-empty"><i class="fas fa-search"></i> Nessun birrificio trovato</div>';
        return;
    }

    dropdown.innerHTML = filtered.map((b, i) => {
        const displayName = q ? highlightMatch(b.name, q) : escapeHtmlContent(b.name);
        return `<div class="searchable-select-item ${i === highlightedBreweryIdx ? 'highlighted' : ''} ${b._id === selectedEditBreweryId ? 'selected' : ''}" data-id="${b._id}" data-name="${escapeAttr(b.name)}" onclick="selectBreweryItem(this)">
            <span class="item-main">${displayName}</span>
        </div>`;
    }).join('') + `<div class="searchable-select-count">${filtered.length} di ${cachedBreweries.length} birrifici</div>`;
}

/**
 * Renderizza il dropdown delle birre filtrate per testo e birrificio
 */
function renderBeerDropdown(query) {
    const dropdown = document.getElementById('beerDropdown');
    if (!dropdown || !cachedBeers) return;

    const q = query.toLowerCase();

    // Prima filtra per birrificio selezionato, poi per testo
    let pool = cachedBeers;
    let isFiltered = false;
    if (selectedEditBreweryId) {
        const byBrewery = cachedBeers.filter(b => b.breweryId === selectedEditBreweryId);
        if (byBrewery.length > 0) {
            pool = byBrewery;
            isFiltered = true;
        }
    }

    const filtered = q.length > 0
        ? pool.filter(b => b.name.toLowerCase().includes(q) || b.breweryName.toLowerCase().includes(q))
        : pool;

    if (filtered.length === 0) {
        dropdown.innerHTML = '<div class="searchable-select-empty"><i class="fas fa-search"></i> Nessuna birra trovata</div>';
        return;
    }

    const beerHidden = document.getElementById('editBeerValue');
    const currentBeer = beerHidden ? beerHidden.value : '';

    dropdown.innerHTML = filtered.map((b, i) => {
        const displayName = q ? highlightMatch(b.name, q) : escapeHtmlContent(b.name);
        return `<div class="searchable-select-item ${i === highlightedBeerIdx ? 'highlighted' : ''} ${b._id === currentBeer ? 'selected' : ''}" data-id="${b._id}" data-name="${escapeAttr(b.name)}" data-brewery-id="${b.breweryId}" data-type="${escapeAttr(b.beerType)}" data-abv="${escapeAttr(b.alcoholContent)}" onclick="selectBeerItem(this)">
            <span class="item-main">${displayName}</span>
            <span class="item-sub"><i class="fas fa-industry" style="font-size: 0.55rem;"></i> ${escapeHtmlContent(b.breweryName)}${b.beerType ? ' &middot; ' + escapeHtmlContent(b.beerType) : ''}${b.alcoholContent ? ' &middot; ' + escapeHtmlContent(b.alcoholContent) + '%' : ''}</span>
        </div>`;
    }).join('') + `<div class="searchable-select-count">${filtered.length}${isFiltered ? ' del birrificio' : ''} di ${cachedBeers.length} birre totali</div>`;
}

/**
 * Seleziona un birrificio dal dropdown
 */
function selectBreweryItem(el) {
    const id = el.dataset.id;
    const name = el.dataset.name;
    const input = document.getElementById('editBreweryInput');
    const hidden = document.getElementById('editBreweryValue');
    const wrapper = document.getElementById('brewerySearchable');

    input.value = name;
    hidden.value = id;
    const previousBreweryId = selectedEditBreweryId;
    selectedEditBreweryId = id;
    wrapper.classList.add('has-value');
    closeDropdown('brewery');

    // Se il birrificio è cambiato, resetta la birra selezionata
    if (previousBreweryId !== id) {
        const beerInput = document.getElementById('editBeerInput');
        const beerHidden = document.getElementById('editBeerValue');
        const beerWrapper = document.getElementById('beerSearchable');
        if (beerInput) beerInput.value = '';
        if (beerHidden) beerHidden.value = '';
        if (beerWrapper) beerWrapper.classList.remove('has-value');

        // Resetta anche tipo e gradazione
        const typeInput = document.getElementById('editBeerType');
        const abvInput = document.getElementById('editAlcoholContent');
        if (typeInput) typeInput.value = '';
        if (abvInput) abvInput.value = '';
    }

    // Aggiorna il dropdown birre per mostrare quelle del birrificio selezionato
    renderBeerDropdown('');
}

/**
 * Seleziona una birra dal dropdown
 */
function selectBeerItem(el) {
    const id = el.dataset.id;
    const name = el.dataset.name;
    const breweryId = el.dataset.breweryId;
    const input = document.getElementById('editBeerInput');
    const hidden = document.getElementById('editBeerValue');
    const wrapper = document.getElementById('beerSearchable');

    input.value = name;
    hidden.value = id;
    wrapper.classList.add('has-value');
    closeDropdown('beer');

    // Auto-popola tipo e gradazione dalla birra selezionata
    const beerType = el.dataset.type || '';
    const abv = el.dataset.abv || '';
    if (beerType) {
        const typeInput = document.getElementById('editBeerType');
        if (typeInput) typeInput.value = beerType;
    }
    if (abv) {
        const abvInput = document.getElementById('editAlcoholContent');
        if (abvInput) abvInput.value = abv;
    }

    // Auto-seleziona il birrificio associato
    if (breweryId) {
        const brInput = document.getElementById('editBreweryInput');
        const brHidden = document.getElementById('editBreweryValue');
        const brWrapper = document.getElementById('brewerySearchable');
        if (brHidden && brHidden.value !== breweryId && cachedBreweries) {
            const br = cachedBreweries.find(b => b._id === breweryId);
            if (br) {
                brInput.value = br.name;
                brHidden.value = br._id;
                selectedEditBreweryId = br._id;
                brWrapper.classList.add('has-value');
            }
        }
    }
}

/**
 * Pulisce la selezione di un searchable select
 */
function clearSearchableSelect(type) {
    if (type === 'brewery') {
        document.getElementById('editBreweryInput').value = '';
        document.getElementById('editBreweryValue').value = '';
        document.getElementById('brewerySearchable').classList.remove('has-value');
        selectedEditBreweryId = '';
        // Aggiorna dropdown birre (mostra tutte)
        const beerInput = document.getElementById('editBeerInput');
        renderBeerDropdown(beerInput ? beerInput.value.trim() : '');
    } else {
        document.getElementById('editBeerInput').value = '';
        document.getElementById('editBeerValue').value = '';
        document.getElementById('beerSearchable').classList.remove('has-value');
    }
}

/**
 * Gestione tastiera (frecce, invio, escape) nei dropdown
 */
function handleDropdownKeyboard(e, type) {
    const dropdown = document.getElementById(type === 'brewery' ? 'breweryDropdown' : 'beerDropdown');
    const items = dropdown ? dropdown.querySelectorAll('.searchable-select-item') : [];
    if (!items.length) return;

    let idx = type === 'brewery' ? highlightedBreweryIdx : highlightedBeerIdx;

    if (e.key === 'ArrowDown') {
        e.preventDefault();
        idx = Math.min(idx + 1, items.length - 1);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        idx = Math.max(idx - 1, 0);
    } else if (e.key === 'Enter') {
        e.preventDefault();
        if (idx >= 0 && idx < items.length) {
            items[idx].click();
        }
        return;
    } else if (e.key === 'Escape') {
        closeDropdown(type);
        return;
    } else {
        return;
    }

    if (type === 'brewery') highlightedBreweryIdx = idx;
    else highlightedBeerIdx = idx;

    items.forEach((it, i) => it.classList.toggle('highlighted', i === idx));
    // Scroll into view
    if (items[idx]) items[idx].scrollIntoView({ block: 'nearest' });
}

/**
 * Apre un dropdown
 */
function openDropdown(type) {
    const id = type === 'brewery' ? 'brewerySearchable' : 'beerSearchable';
    document.getElementById(id)?.classList.add('open');
}

/**
 * Chiude un dropdown
 */
function closeDropdown(type) {
    const id = type === 'brewery' ? 'brewerySearchable' : 'beerSearchable';
    document.getElementById(id)?.classList.remove('open');
    if (type === 'brewery') highlightedBreweryIdx = -1;
    else highlightedBeerIdx = -1;
}

/**
 * Evidenzia la parte di testo che corrisponde alla query
 */
function highlightMatch(text, query) {
    if (!query) return escapeHtmlContent(text);
    const escaped = escapeHtmlContent(text);
    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return escaped.replace(regex, '<mark>$1</mark>');
}

/**
 * Invia le modifiche alla recensione
 */
async function submitEditReview() {
    if (!editCurrentReviewId) return;

    const saveBtn = document.getElementById('editSaveBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvataggio...';

    try {
        const breweryId = document.getElementById('editBreweryValue')?.value || '';
        const beerId = document.getElementById('editBeerValue')?.value || '';
        const beerType = document.getElementById('editBeerType')?.value?.trim() || '';
        const alcoholContent = document.getElementById('editAlcoholContent')?.value?.trim() || '';
        const notes = document.getElementById('editNotes')?.value || '';

        const response = await fetch(`/administrator/api/reviews/${editCurrentReviewId}/edit`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                breweryId,
                beerId,
                beerType,
                alcoholContent,
                notes
            })
        });

        const data = await response.json();

        if (data.success) {
            closeModal('editReviewModal');
            // Mostra toast e ricarica
            if (typeof showToast === 'function') {
                showToast('success', data.message || 'Recensione aggiornata con successo');
            }
            setTimeout(() => window.location.reload(), 1000);
        } else {
            alert(data.error || 'Errore durante il salvataggio');
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    } catch (error) {
        console.error('Errore salvataggio modifica:', error);
        alert('Errore di connessione durante il salvataggio');
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
    }
}

/**
 * Escape attributi HTML per prevenire XSS nei value
 */
function escapeAttr(str) {
    if (!str) return '';
    return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

/**
 * Escape contenuto HTML per textarea
 */
function escapeHtmlContent(str) {
    if (!str) return '';
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}
</script>
{% endblock %}
