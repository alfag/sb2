{% extends "../layout.njk" %}
{% block title %}Validazione Birrifici{% endblock %}
{% block head %}<link rel="stylesheet" href="/css/admin-dashboard.css">{% endblock %}

{% block content %}
<div class="admin-page">
    <div class="page-head">
        <h1><i class="fas fa-shield-alt"></i> Validazione Birrifici</h1>
        <a href="/administrator" class="btn-add"><i class="fas fa-arrow-left"></i> Dashboard</a>
    </div>

    <div class="stats-row">
        <div class="stat-box" style="--accent:var(--dash-yellow)"><i class="fas fa-clock"></i><div class="num">{{ count or 0 }}</div><div class="lbl">In Attesa</div></div>
        <div class="stat-box" style="--accent:var(--dash-green)"><i class="fas fa-check-circle"></i><div class="num" id="validatedToday">-</div><div class="lbl">Validati Oggi</div></div>
    </div>

    {% if count > 0 %}
    <div class="validation-list" id="breweriesList">
        {% for b in breweries %}
        <div class="validation-card" id="brewery-{{ b._id }}">
            <div class="validation-head">
                <div class="validation-title">
                    <h3>{{ b.breweryName or 'Nome non disponibile' }}</h3>
                    <span class="role-badge" style="--badge-bg:{% if b.dataSource == 'web_scraped' %}var(--dash-green){% else %}var(--dash-blue){% endif %}">{% if b.dataSource == 'web_scraped' %}Web{% else %}AI{% endif %}</span>
                </div>
                <div class="validation-actions">
                    <button class="btn-approve" onclick="approveBrewery('{{ b._id }}')" title="Approva"><i class="fas fa-check"></i></button>
                    <button class="btn-edit" onclick="editBrewery('{{ b._id }}')" title="Modifica"><i class="fas fa-edit"></i></button>
                    <button class="btn-reject" onclick="rejectBrewery('{{ b._id }}')" title="Rifiuta"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="validation-details">
                {% if b.breweryWebsite %}<div class="vd-item"><i class="fas fa-globe"></i><a href="{{ b.breweryWebsite }}" target="_blank">{{ b.breweryWebsite | truncate(40) }}</a></div>{% endif %}
                {% if b.breweryEmail %}<div class="vd-item"><i class="fas fa-envelope"></i>{{ b.breweryEmail }}</div>{% endif %}
                {% if b.breweryPhoneNumber %}<div class="vd-item"><i class="fas fa-phone"></i>{{ b.breweryPhoneNumber }}</div>{% endif %}
                {% if b.breweryLegalAddress %}<div class="vd-item"><i class="fas fa-map-marker-alt"></i>{{ b.breweryLegalAddress | truncate(50) }}</div>{% endif %}
                {% if b.foundingYear %}<div class="vd-item"><i class="fas fa-calendar"></i>{{ b.foundingYear }}</div>{% endif %}
                {% if b.breweryDescription %}<div class="vd-item full"><i class="fas fa-align-left"></i>{{ b.breweryDescription | truncate(150) }}</div>{% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state"><i class="fas fa-check-double"></i><p>Nessun birrificio in attesa di validazione</p></div>
    {% endif %}
</div>

<!-- Modal Modifica -->
<div id="editModal" class="modal-overlay" style="display:none">
    <div class="modal-box">
        <div class="modal-head"><h3><i class="fas fa-edit"></i> Modifica Birrificio</h3><button class="modal-close" onclick="closeEditModal()">&times;</button></div>
        <form id="editBreweryForm" class="modal-form">
            <input type="hidden" id="editBreweryId">
            <div class="form-row">
                <label>Nome *</label><input type="text" id="editBreweryName" required>
            </div>
            <div class="form-row">
                <label>Sito Web</label><input type="url" id="editBreweryWebsite">
            </div>
            <div class="form-row">
                <label>Email</label><input type="email" id="editBreweryEmail">
            </div>
            <div class="form-row">
                <label>Telefono</label><input type="tel" id="editBreweryPhone">
            </div>
            <div class="form-row">
                <label>Indirizzo</label><textarea id="editBreweryAddress" rows="2"></textarea>
            </div>
            <div class="form-row">
                <label>Descrizione</label><textarea id="editBreweryDescription" rows="3"></textarea>
            </div>
            <div class="form-row">
                <label>Anno Fondazione</label><input type="number" id="editFoundingYear" min="1800" max="2025">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-delete" onclick="closeEditModal()">Annulla</button>
                <button type="submit" class="btn-add">Salva e Approva</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function approveBrewery(id){
    if(!confirm('Approvare questo birrificio?'))return;
    try{
        const r=await fetch(`/administrator/validation/brewery/${id}/approve`,{method:'POST',headers:{'Content-Type':'application/json'}});
        const d=await r.json();
        if(d.success){document.getElementById(`brewery-${id}`).remove();location.reload();}
        else alert('Errore: '+d.error);
    }catch(e){console.error(e);alert('Errore approvazione');}
}
async function rejectBrewery(id){
    const reason=prompt('Motivo rifiuto (opzionale):');
    if(reason===null)return;
    try{
        const r=await fetch(`/administrator/validation/brewery/${id}/reject`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({reason})});
        const d=await r.json();
        if(d.success){document.getElementById(`brewery-${id}`).remove();location.reload();}
        else alert('Errore: '+d.error);
    }catch(e){console.error(e);alert('Errore rifiuto');}
}
function editBrewery(id){document.getElementById('editModal').style.display='flex';document.getElementById('editBreweryId').value=id;}
function closeEditModal(){document.getElementById('editModal').style.display='none';}
document.getElementById('editBreweryForm').addEventListener('submit',async function(e){
    e.preventDefault();
    const id=document.getElementById('editBreweryId').value;
    const data={
        breweryName:document.getElementById('editBreweryName').value,
        breweryWebsite:document.getElementById('editBreweryWebsite').value,
        breweryEmail:document.getElementById('editBreweryEmail').value,
        breweryPhoneNumber:document.getElementById('editBreweryPhone').value,
        breweryLegalAddress:document.getElementById('editBreweryAddress').value,
        breweryDescription:document.getElementById('editBreweryDescription').value,
        foundingYear:document.getElementById('editFoundingYear').value
    };
    try{
        const r=await fetch(`/administrator/validation/brewery/${id}/update-approve`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
        const d=await r.json();
        if(d.success){closeEditModal();location.reload();}
        else alert('Errore: '+d.error);
    }catch(e){console.error(e);alert('Errore salvataggio');}
});
</script>
{% endblock %}
