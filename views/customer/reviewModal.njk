{# Modal Popup per Recensioni - Creato: 17 Ottobre 2025 #}

<!-- Review Modal Overlay -->
<div id="reviewModalOverlay" class="review-modal-overlay">
  <div class="review-modal-container">
    
    <!-- Header -->
    <div class="review-modal-header">
      <h2 class="review-modal-title">
        <i class="fas fa-star"></i>
        Valuta le Tue Birre
      </h2>
      <button 
        type="button" 
        id="closeReviewModal" 
        class="review-modal-close"
        aria-label="Chiudi"
      >
        √ó
      </button>
    </div>

    <!-- Body - Scrollable -->
    <div class="review-modal-body" id="reviewModalBody">
      <!-- Contenuto generato dinamicamente via JavaScript -->
      <div id="bottleRatingsContainer"></div>
    </div>

    <!-- Footer -->
    <div class="review-modal-footer">
      <div class="review-progress-info" id="reviewProgressInfo" style="display: none;">
        <i class="fas fa-info-circle"></i>
        <span id="reviewProgressText"></span>
      </div>
      <div class="footer-buttons">
        <button 
          type="button" 
          id="cancelReviewBtn" 
          class="modal-btn modal-btn-cancel"
        >
          <i class="fas fa-times"></i>
          Annulla
        </button>
        <button 
          type="button" 
          id="submitReviewBtn" 
          class="modal-btn modal-btn-submit"
        >
          <i class="fas fa-check"></i>
          Pubblica Recensioni
        </button>
      </div>
    </div>

  </div>
</div>

<script>
// Inizializzazione Modal Recensioni
(function() {
  console.log('üé¨ Review Modal Script Loaded');
  
  // Riferimenti DOM
  const modalOverlay = document.getElementById('reviewModalOverlay');
  const modalBody = document.getElementById('reviewModalBody');
  const bottleContainer = document.getElementById('bottleRatingsContainer');
  const closeBtn = document.getElementById('closeReviewModal');
  const cancelBtn = document.getElementById('cancelReviewBtn');
  const submitBtn = document.getElementById('submitReviewBtn');
  
  // Stato globale recensioni
  window.reviewModalState = {
    bottles: [],
    ratings: {}
  };
  
  /**
   * Apre il modal con i dati delle bottiglie
   * @param {Array} bottles - Array di bottiglie da recensire
   */
  window.openReviewModal = function(bottles) {
    console.log('üìñ Opening review modal with bottles:', bottles);
    
    if (!bottles || bottles.length === 0) {
      console.error('‚ùå Nessuna bottiglia da recensire');
      return;
    }
    
    window.reviewModalState.bottles = bottles;
    window.reviewModalState.ratings = {};
    
    // Genera HTML per ogni bottiglia
    renderBottles(bottles);
    
    // Mostra modal
    modalOverlay.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // üéØ Nascondi il bottone "Recensisci una birra" quando il modal si apre
    const startReviewBtn = document.getElementById('start-review-process');
    if (startReviewBtn) {
      startReviewBtn.style.display = 'none';
      console.log('‚úÖ Bottone "Recensisci una birra" nascosto');
    }
    
    // Setup event listeners per le stelle
    setupStarRatings();
    
    // Mostra progress info se pi√π bottiglie
    updateProgressInfo();
  };
  
  /**
   * Chiude il modal
   */
  function closeModal() {
    modalOverlay.classList.remove('active');
    document.body.style.overflow = '';
    
    // Reset contenuto
    bottleContainer.innerHTML = '';
    window.reviewModalState = { bottles: [], ratings: {} };
    
    // üßπ CLEANUP: Rimuovi la vecchia UI inline di recensione se esiste
    const legacyReviewProcess = document.getElementById('review-process');
    if (legacyReviewProcess) {
      legacyReviewProcess.classList.add('hidden');
      legacyReviewProcess.innerHTML = ''; // Pulisci contenuto
    }
    
    // Ripulisci anche eventuali messaggi di errore/warning
    const dynamicAlerts = document.querySelectorAll('.dynamic-alert, .alert-warning, .alert-danger');
    dynamicAlerts.forEach(alert => alert.remove());
    
    // üîÑ RIPRISTINA interfaccia iniziale con bottone "Recensisci una birra"
    const startReviewBtn = document.getElementById('start-review-process');
    if (startReviewBtn) {
      startReviewBtn.style.display = 'inline-flex';
      console.log('‚úÖ Bottone "Recensisci una birra" ripristinato');
    }
    
    // Ripulisci anche notifiche globali se presenti
    if (window.utils && window.utils.clearNotifications) {
      window.utils.clearNotifications();
    }
  }
  
  /**
   * Mostra notifica moderna nel modal
   */
  function showModalNotification(message, type = 'info') {
    // Rimuovi notifiche esistenti nel modal body
    const existingNotifications = modalBody.querySelectorAll('.modal-notification');
    existingNotifications.forEach(n => n.remove());
    
    // Crea nuova notifica
    const notification = document.createElement('div');
    notification.className = `modal-notification modal-notification-${type}`;
    
    const icons = {
      error: '‚ùå',
      warning: '‚ö†Ô∏è',
      info: '‚ÑπÔ∏è',
      success: '‚úÖ'
    };
    
    notification.innerHTML = `
      <span class="modal-notification-icon">${icons[type] || icons.info}</span>
      <span class="modal-notification-message">${message}</span>
      <button class="modal-notification-close">√ó</button>
    `;
    
    // Inserisci all'inizio del modal body
    modalBody.insertBefore(notification, modalBody.firstChild);
    
    // Animazione entrata
    setTimeout(() => notification.classList.add('show'), 10);
    
    // Close button
    const closeBtnNotif = notification.querySelector('.modal-notification-close');
    closeBtnNotif.addEventListener('click', () => {
      notification.classList.remove('show');
      setTimeout(() => notification.remove(), 300);
    });
    
    // Auto-dismiss dopo 8 secondi per errori, 5 per gli altri
    const dismissTime = type === 'error' ? 8000 : 5000;
    setTimeout(() => {
      if (notification.parentNode) {
        notification.classList.remove('show');
        setTimeout(() => {
          if (notification.parentNode) notification.remove();
        }, 300);
      }
    }, dismissTime);
    
    // Scroll al top per vedere la notifica
    modalBody.scrollTop = 0;
  }
  
  /**
   * Renderizza le bottiglie nel modal
   */
  function renderBottles(bottles) {
    console.log('üì¶ Rendering ' + bottles.length + ' bottle(s) in modal');
    console.log('üîç DEBUG bottles data:', JSON.stringify(bottles, null, 2));
    
    let html = '';
    
    for (let index = 0; index < bottles.length; index++) {
      const bottle = bottles[index];
      
      console.log('üç∫ DEBUG bottle ' + index + ':', {
        thumbnail: bottle.thumbnail,
        imageDataUrl: bottle.imageDataUrl,
        image: bottle.image,
        beerName: bottle.beerName,
        bottleLabel: bottle.bottleLabel
      });
      
      // Calcola testo posizione per bottiglie multiple
      let positionText = '';
      if (bottles.length > 1) {
        const positions = ['prima', 'seconda', 'terza', 'quarta', 'quinta', 'sesta', 'settima', 'ottava', 'nona', 'decima'];
        let posWord;
        if (positions[index]) {
          posWord = positions[index];
        } else {
          const indexPlusOne = index + 1;
          posWord = String(indexPlusOne) + '¬∞';
        }
        const beerNumber = index + 1;
        positionText = 'Birra ' + String(beerNumber) + ' (' + posWord + ' bottiglia da sinistra)';
      }
      
      const bottleCounterHtml = bottles.length > 1 ? '<div class="bottle-counter">' + positionText + '</div>' : '';
      const beerNameFallback = 'Birra ' + String(index + 1);
      
      // Usa thumbnail reale o imageDataUrl, EVITA svg/gif di default
      const thumbnailSrc = bottle.thumbnail || bottle.imageDataUrl || bottle.image || '';
      const beerName = bottle.beerName || beerNameFallback;
      
      html += '<div class="review-bottle-card" data-bottle-index="' + index + '">';
      html += bottleCounterHtml;
      html += '<div class="bottle-header-inline">';
      html += '  <img src="' + thumbnailSrc + '" ';
      html += '       alt="Bottiglia ' + (index + 1) + '" ';
      html += '       class="bottle-thumbnail-inline"';
      html += '       style="display:' + (thumbnailSrc ? 'block' : 'none') + '"';
      html += '       onerror="this.style.display=\'none\'">';
      html += '  <div class="bottle-info-inline">';
      html += '    <h3 class="bottle-name-inline">';
      html += '      <i class="fas fa-beer"></i>';
      html += '      ' + beerName;
      html += '    </h3>';
      html += '  </div>';
      html += '</div>';
      
      // Valutazione Generale
      html += '<div class="rating-section">';
      html += '  <label class="rating-label">';
      html += '    <i class="fas fa-star"></i> Valutazione Generale';
      html += '  </label>';
      html += '  <div class="rating-wrapper">';
      html += '    <div class="star-rating-container" data-bottle="' + index + '" data-category="overall">';
      for (let rating = 1; rating <= 5; rating++) {
        html += '      <span class="star-icon" data-rating="' + rating + '">‚òÖ</span>';
      }
      html += '    </div>';
      html += '  </div>';
      html += '</div>';
      
      // Note Generali
      html += '<div class="rating-section">';
      html += '  <label class="rating-label">';
      html += '    <i class="fas fa-comment"></i> Impressioni Generali';
      html += '  </label>';
      html += '  <textarea ';
      html += '    class="review-notes-textarea" ';
      html += '    placeholder="Condividi le tue impressioni su questa birra..."';
      html += '    rows="3"';
      html += '    data-bottle="' + index + '" ';
      html += '    data-category="general"';
      html += '  ></textarea>';
      html += '</div>';
      
      // Toggle Valutazioni Dettagliate
      html += '<button ';
      html += '  type="button" ';
      html += '  class="toggle-detailed-btn" ';
      html += '  data-bottle="' + index + '"';
      html += '>';
      html += '  <i class="fas fa-chevron-down"></i>';
      html += '  Valutazione Dettagliata';
      html += '</button>';
      
      // Valutazioni Dettagliate (nascoste)
      html += '<div class="detailed-ratings-container" data-bottle="' + index + '">';
      
      // Aspetto
      html += '  <div class="rating-section">';
      html += '    <label class="rating-label">';
      html += '      <i class="fas fa-eye"></i> Aspetto (colore, limpidezza, schiuma)';
      html += '    </label>';
      html += '    <div class="rating-wrapper">';
      html += '      <div class="star-rating-container" data-bottle="' + index + '" data-category="appearance">';
      for (let rating = 1; rating <= 5; rating++) {
        html += '        <span class="star-icon" data-rating="' + rating + '">‚òÖ</span>';
      }
      html += '      </div>';
      html += '    </div>';
      html += '    <textarea ';
      html += '      class="review-notes-textarea" ';
      html += '      placeholder="Note sull\'aspetto..."';
      html += '      rows="2"';
      html += '      data-bottle="' + index + '" ';
      html += '      data-category="appearance"';
      html += '    ></textarea>';
      html += '  </div>';
      
      // Aroma
      html += '  <div class="rating-section">';
      html += '    <label class="rating-label">';
      html += '      <i class="fas fa-wind"></i> Aroma (profumi e odori)';
      html += '    </label>';
      html += '    <div class="rating-wrapper">';
      html += '      <div class="star-rating-container" data-bottle="' + index + '" data-category="aroma">';
      for (let rating = 1; rating <= 5; rating++) {
        html += '        <span class="star-icon" data-rating="' + rating + '">‚òÖ</span>';
      }
      html += '      </div>';
      html += '    </div>';
      html += '    <textarea ';
      html += '      class="review-notes-textarea" ';
      html += '      placeholder="Note sull\'aroma..."';
      html += '      rows="2"';
      html += '      data-bottle="' + index + '" ';
      html += '      data-category="aroma"';
      html += '    ></textarea>';
      html += '  </div>';
      
      // Gusto
      html += '  <div class="rating-section">';
      html += '    <label class="rating-label">';
      html += '      <i class="fas fa-glass-cheers"></i> Gusto (sapore e bilanciamento)';
      html += '    </label>';
      html += '    <div class="rating-wrapper">';
      html += '      <div class="star-rating-container" data-bottle="' + index + '" data-category="taste">';
      for (let rating = 1; rating <= 5; rating++) {
        html += '        <span class="star-icon" data-rating="' + rating + '">‚òÖ</span>';
      }
      html += '      </div>';
      html += '    </div>';
      html += '    <textarea ';
      html += '      class="review-notes-textarea" ';
      html += '      placeholder="Note sul gusto..."';
      html += '      rows="2"';
      html += '      data-bottle="' + index + '" ';
      html += '      data-category="taste"';
      html += '    ></textarea>';
      html += '  </div>';
      
      // Mouthfeel
      html += '  <div class="rating-section">';
      html += '    <label class="rating-label">';
      html += '      <i class="fas fa-hand-holding-water"></i> Sensazione in bocca (corpo, carbonazione)';
      html += '    </label>';
      html += '    <div class="rating-wrapper">';
      html += '      <div class="star-rating-container" data-bottle="' + index + '" data-category="mouthfeel">';
      for (let rating = 1; rating <= 5; rating++) {
        html += '        <span class="star-icon" data-rating="' + rating + '">‚òÖ</span>';
      }
      html += '      </div>';
      html += '    </div>';
      html += '    <textarea ';
      html += '      class="review-notes-textarea" ';
      html += '      placeholder="Note sulla sensazione in bocca..."';
      html += '      rows="2"';
      html += '      data-bottle="' + index + '" ';
      html += '      data-category="mouthfeel"';
      html += '    ></textarea>';
      html += '  </div>';
      
      html += '</div>'; // chiudi detailed-ratings-container
      html += '</div>'; // chiudi review-bottle-card
    }
    
    bottleContainer.innerHTML = html;
  }
  
  /**
   * Setup event listeners per le stelle
   */
  function setupStarRatings() {
    // Stelle di rating
    const starContainers = document.querySelectorAll('.star-rating-container');
    
    starContainers.forEach(container => {
      const stars = container.querySelectorAll('.star-icon');
      const bottleIndex = container.dataset.bottle;
      const category = container.dataset.category;
      
      stars.forEach((star, index) => {
        // Click per selezionare rating
        star.addEventListener('click', function() {
          const rating = parseInt(this.dataset.rating);
          selectRating(container, rating, bottleIndex, category);
        });
        
        // Hover preview
        star.addEventListener('mouseenter', function() {
          const rating = parseInt(this.dataset.rating);
          previewRating(container, rating);
        });
        
        // Reset hover quando mouse esce dalla stella
        star.addEventListener('mouseleave', function() {
          resetHoverPreview(container);
        });
      });
      
      // Reset hover quando mouse esce dal container
      container.addEventListener('mouseleave', function() {
        resetHoverPreview(container);
      });
    });
    
    // Toggle valutazioni dettagliate
    const toggleBtns = document.querySelectorAll('.toggle-detailed-btn');
    toggleBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        const bottleIndex = this.dataset.bottle;
        const detailedContainer = document.querySelector(`.detailed-ratings-container[data-bottle="${bottleIndex}"]`);
        
        if (detailedContainer.classList.contains('active')) {
          detailedContainer.classList.remove('active');
          this.classList.remove('expanded');
          this.innerHTML = '<i class="fas fa-chevron-down"></i> Valutazione Dettagliata';
        } else {
          detailedContainer.classList.add('active');
          this.classList.add('expanded');
          this.innerHTML = '<i class="fas fa-chevron-up"></i> Nascondi Dettagli';
        }
      });
    });
  }
  
  /**
   * Seleziona rating e illumina stelle
   */
  function selectRating(container, rating, bottleIndex, category) {
    const stars = container.querySelectorAll('.star-icon');
    const valueDisplay = document.querySelector(`.rating-value-display[data-bottle="${bottleIndex}"][data-category="${category}"]`);
    
    // Rimuovi classe active e stili inline da tutte le stelle
    stars.forEach(star => {
      star.classList.remove('active');
      star.style.color = ''; // Reset inline styles
      star.style.opacity = '';
    });
    
    // Aggiungi classe active alle stelle selezionate (da 1 a rating)
    stars.forEach((star, index) => {
      if (index < rating) {
        star.classList.add('active');
      }
    });
    
    // Aggiorna valore display
    if (valueDisplay) {
      valueDisplay.textContent = rating;
      valueDisplay.classList.add('has-rating');
    }
    
    // Salva nel state
    if (!window.reviewModalState.ratings[bottleIndex]) {
      window.reviewModalState.ratings[bottleIndex] = {};
    }
    window.reviewModalState.ratings[bottleIndex][category] = rating;
    
    console.log('‚≠ê Rating selezionato:', { bottleIndex, category, rating });
    
    // Aggiorna progress info
    updateProgressInfo();
  }
  
  /**
   * Aggiorna l'indicatore di progresso nel footer
   */
  function updateProgressInfo() {
    const progressInfo = document.getElementById('reviewProgressInfo');
    const progressText = document.getElementById('reviewProgressText');
    const totalBottles = window.reviewModalState.bottles.length;
    
    if (!progressInfo || !progressText || totalBottles <= 1) return;
    
    let completedCount = 0;
    for (let i = 0; i < totalBottles; i++) {
      const ratings = window.reviewModalState.ratings[i] || {};
      if (ratings.overall && ratings.overall > 0) {
        completedCount++;
      }
    }
    
    progressInfo.style.display = 'flex';
    progressText.textContent = `${completedCount} di ${totalBottles} birre recensite`;
    
    // Cambia colore se tutte completate
    if (completedCount === totalBottles) {
      progressInfo.style.background = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
      progressInfo.style.color = '#065f46';
    } else {
      progressInfo.style.background = 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)';
      progressInfo.style.color = '#1e40af';
    }
  }
  
  /**
   * Preview rating on hover
   */
  function previewRating(container, rating) {
    const stars = container.querySelectorAll('.star-icon');
    stars.forEach((star, index) => {
      if (index < rating && !star.classList.contains('active')) {
        star.style.color = '#fbbf24';
        star.style.opacity = '0.7';
      }
    });
  }
  
  /**
   * Reset hover preview
   */
  function resetHoverPreview(container) {
    const stars = container.querySelectorAll('.star-icon');
    stars.forEach(star => {
      if (!star.classList.contains('active')) {
        star.style.color = '';
        star.style.opacity = '';
      }
    });
  }
  
  /**
   * Raccogli tutti i dati delle recensioni
   */
  function collectReviewData() {
    const reviews = [];
    const bottles = window.reviewModalState.bottles;
    
    bottles.forEach((bottle, index) => {
      const ratings = window.reviewModalState.ratings[index] || {};
      const notes = {};
      
      // Raccogli note da tutti i textarea
      document.querySelectorAll(`textarea[data-bottle="${index}"]`).forEach(textarea => {
        const category = textarea.dataset.category;
        notes[category] = textarea.value.trim();
      });
      
      const reviewData = {
        ...bottle,
        overallRating: ratings.overall || 0,
        appearanceRating: ratings.appearance || 0,
        aromaRating: ratings.aroma || 0,
        tasteRating: ratings.taste || 0,
        mouthfeelRating: ratings.mouthfeel || 0,
        generalNotes: notes.general || '',
        appearanceNotes: notes.appearance || '',
        aromaNotes: notes.aroma || '',
        tasteNotes: notes.taste || '',
        mouthfeelNotes: notes.mouthfeel || ''
      };
      
      console.log(`üìù Review data for bottle ${index}:`, {
        beerName: reviewData.beerName,
        overallRating: reviewData.overallRating,
        ratings: ratings
      });
      
      reviews.push(reviewData);
    });
    
    console.log('üì¶ Complete reviews array:', reviews);
    return reviews;
  }
  
  /**
   * Valida che almeno il rating generale sia presente
   */
  function validateReviews() {
    const bottles = window.reviewModalState.bottles;
    console.log(`üîç Validating ${bottles.length} bottle review(s)...`);
    
    for (let i = 0; i < bottles.length; i++) {
      const ratings = window.reviewModalState.ratings[i] || {};
      console.log(`  Bottle ${i + 1} ratings:`, ratings);
      
      if (!ratings.overall || ratings.overall === 0) {
        const bottleName = bottles[i].beerName || 'senza nome';
        const message = bottles.length > 1 
          ? `Per favore, dai una valutazione generale alla birra ${i + 1} di ${bottles.length}: "${bottleName}"`
          : `Per favore, dai una valutazione generale alla birra "${bottleName}"`;
        
        console.warn(`‚ùå Validation failed for bottle ${i + 1}`);
        return { valid: false, message };
      }
    }
    
    console.log('‚úÖ All reviews validated successfully');
    return { valid: true };
  }
  
  // Event Listeners
  closeBtn?.addEventListener('click', closeModal);
  cancelBtn?.addEventListener('click', closeModal);
  
  submitBtn?.addEventListener('click', function() {
    // üõ°Ô∏è PROTEZIONE ANTI-DOPPIO-CLICK: evita invii multipli
    if (submitBtn.disabled) {
      console.warn('‚ö†Ô∏è Click ignorato - invio gi√† in corso');
      return;
    }
    
    const validation = validateReviews();
    
    if (!validation.valid) {
      // ‚ú® Usa notifica moderna invece di alert
      showModalNotification(validation.message, 'error');
      return; // ‚ùå NON chiudere il modal - lascialo aperto per correzioni
    }
    
    // üîí Disabilita il pulsante e mostra stato di caricamento
    submitBtn.disabled = true;
    const originalText = submitBtn.innerHTML;
    submitBtn.dataset.originalText = originalText; // üîß FIX: Salva per recovery in .finally()
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Invio in corso...';
    submitBtn.style.opacity = '0.7';
    submitBtn.style.cursor = 'not-allowed';
    
    const reviews = collectReviewData();
    console.log('üì§ Submitting reviews:', reviews);
    
    // Chiama funzione globale se esiste (da scripts.js)
    if (typeof window.submitReviews === 'function') {
      // Passa anche callback per gestire successo/errore
      window.submitReviews(reviews, {
        onSuccess: () => {
          console.log('‚úÖ Recensioni pubblicate - chiudo modal');
          closeModal(); // ‚úÖ Chiudi SOLO se successo
          // Non serve riabilitare - il modal si chiude
        },
        onError: (errorMessage) => {
          console.error('‚ùå Errore pubblicazione - modal rimane aperto');
          // üîì Riabilita il pulsante in caso di errore per permettere nuovo tentativo
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
          submitBtn.style.opacity = '1';
          submitBtn.style.cursor = 'pointer';
          // Mostra errore nel modal (non chiudere!)
          showModalNotification(errorMessage, 'error');
        }
      });
    } else {
      console.error('‚ùå window.submitReviews() non trovata');
      // üîì Riabilita il pulsante in caso di errore
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
      submitBtn.style.opacity = '1';
      submitBtn.style.cursor = 'pointer';
      showModalNotification('Errore tecnico: funzione di invio non disponibile', 'error');
      return; // ‚ùå NON chiudere il modal
    }
    
    // ‚ö†Ô∏è NON chiudere qui - chiudi solo nel callback onSuccess
  });
  
  // Chiudi con ESC
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modalOverlay.classList.contains('active')) {
      closeModal();
    }
  });
  
  // Chiudi cliccando fuori dal modal
  modalOverlay?.addEventListener('click', function(e) {
    if (e.target === modalOverlay) {
      closeModal();
    }
  });
  
  console.log('‚úÖ Review Modal initialized');
})();
</script>
